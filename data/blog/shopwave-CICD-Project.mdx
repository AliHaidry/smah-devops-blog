---
title: "ShopWave: Production-Grade E-Commerce CI/CD on Azure"
subtitle: "A complete end-to-end walkthrough â€” Python FastAPI microservices, AKS, ACR, GitHub Actions, Terraform"
date: "2026-02-20"
author: "Platform Engineering Team"
tags: ["Azure", "AKS", "GitHub Actions", "FastAPI", "Python", "CI/CD", "Microservices", "E-Commerce", "Terraform", "IaC"]
readTime: "40 min read"
project: "ShopWave E-Commerce Platform"
stack: "Python Â· FastAPI Â· Azure AKS Â· ACR Â· Azure DB Â· Terraform Â· GitHub Actions"
---

import { useState } from "react";

{/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    SHARED DESIGN TOKENS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
export const T = {
  bg:        "#08090f",
  surface:   "#0f1117",
  surface2:  "#161a26",
  surface3:  "#1c2130",
  accent:    "#3b82f6",   /* Azure blue */
  accent2:   "#f97316",   /* orange */
  accent3:   "#22c55e",   /* green */
  accent4:   "#a855f7",   /* purple */
  accent5:   "#ec4899",   /* pink */
  warn:      "#eab308",
  danger:    "#ef4444",
  text:      "#e2e8f0",
  muted:     "#64748b",
  border:    "#1e2840",
};

{/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    REUSABLE COMPONENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}

export const Badge = ({ color = T.accent, children }) => (
  <span style={{
    display: "inline-block",
    fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
    fontSize: "10px", letterSpacing: "0.12em",
    textTransform: "uppercase", padding: "3px 9px",
    borderRadius: "3px", border: `1px solid ${color}55`,
    background: `${color}18`, color,
  }}>{children}</span>
);

export const SectionHeader = ({ num, title, sub }) => (
  <div style={{ margin: "64px 0 28px", borderBottom: `1px solid ${T.border}`, paddingBottom: "20px" }}>
    <div style={{ fontFamily: "monospace", fontSize: "11px", color: T.accent, letterSpacing: "0.2em", marginBottom: "8px" }}>
      SECTION {num}
    </div>
    <h2 style={{ fontFamily: "'Bebas Neue', 'Anton', sans-serif", fontSize: "clamp(1.8rem,4vw,2.8rem)", color: "#fff", margin: "0 0 8px", letterSpacing: "0.02em" }}>{title}</h2>
    {sub && <p style={{ color: T.muted, fontSize: "0.95rem", margin: 0 }}>{sub}</p>}
  </div>
);

export const Callout = ({ type = "info", title, children }) => {
  const map = {
    info:    { border: T.accent,  bg: "#0a1628", icon: "â„¹" },
    warn:    { border: T.warn,    bg: "#1a1400", icon: "âš " },
    success: { border: T.accent3, bg: "#0a1a0e", icon: "âœ“" },
    danger:  { border: T.danger,  bg: "#1a0a0a", icon: "âœ—" },
    tip:     { border: T.accent4, bg: "#120a1a", icon: "ğŸ’¡" },
  };
  const s = map[type] || map.info;
  return (
    <div style={{ borderLeft: `3px solid ${s.border}`, background: s.bg, padding: "16px 20px", margin: "24px 0", borderRadius: "0 8px 8px 0" }}>
      {title && <div style={{ fontFamily: "monospace", fontSize: "11px", color: s.border, letterSpacing: "0.15em", textTransform: "uppercase", marginBottom: "8px" }}>{s.icon}  {title}</div>}
      <div style={{ color: T.text, fontSize: "0.92rem", lineHeight: 1.75 }}>{children}</div>
    </div>
  );
};

export const DiagramBox = ({ label, height = "auto", children }) => (
  <div style={{ background: T.surface, border: `1px solid ${T.border}`, borderRadius: "12px", padding: "28px 24px", margin: "28px 0", position: "relative", overflow: "hidden" }}>
    <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: "2px", background: `linear-gradient(90deg,${T.accent},${T.accent4},transparent)` }} />
    <div style={{ fontFamily: "monospace", fontSize: "10px", color: T.muted, textTransform: "uppercase", letterSpacing: "0.18em", marginBottom: "20px", display: "flex", alignItems: "center", gap: "8px" }}>
      <span style={{ width: 5, height: 5, borderRadius: "50%", background: T.accent, boxShadow: `0 0 6px ${T.accent}`, display: "inline-block" }} />
      {label}
    </div>
    {children}
  </div>
);

export const CodeBlock = ({ lang = "yaml", filename, children }) => (
  <div style={{ margin: "20px 0", borderRadius: "10px", overflow: "hidden", border: `1px solid ${T.border}` }}>
    <div style={{ background: T.surface3, padding: "10px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", borderBottom: `1px solid ${T.border}` }}>
      <div style={{ display: "flex", gap: "6px", alignItems: "center" }}>
        <span style={{ width: 10, height: 10, borderRadius: "50%", background: T.danger, display: "inline-block" }} />
        <span style={{ width: 10, height: 10, borderRadius: "50%", background: T.warn,   display: "inline-block" }} />
        <span style={{ width: 10, height: 10, borderRadius: "50%", background: T.accent3,display: "inline-block" }} />
      </div>
      {filename && <span style={{ fontFamily: "monospace", fontSize: "11px", color: T.muted }}>{filename}</span>}
      <Badge color={T.accent4}>{lang}</Badge>
    </div>
    <div style={{ background: "#0a0d14", padding: "20px", overflowX: "auto" }}>
      <pre style={{ margin: 0, fontFamily: "'JetBrains Mono','Fira Code',monospace", fontSize: "12.5px", lineHeight: 1.7, color: "#cdd6f4", whiteSpace: "pre" }}>{children}</pre>
    </div>
  </div>
);

export const FileTree = ({ children }) => (
  <div style={{ background: "#0a0d14", border: `1px solid ${T.border}`, borderRadius: "10px", padding: "20px 24px", margin: "20px 0", fontFamily: "'JetBrains Mono','Fira Code',monospace", fontSize: "12.5px", lineHeight: 1.9, color: "#cdd6f4", overflowX: "auto" }}>
    <pre style={{ margin: 0, whiteSpace: "pre" }}>{children}</pre>
  </div>
);

export const StepCard = ({ num, title, children }) => (
  <div style={{ display: "flex", gap: "20px", margin: "20px 0", padding: "20px", background: T.surface2, border: `1px solid ${T.border}`, borderRadius: "10px" }}>
    <div style={{ flexShrink: 0, width: 36, height: 36, borderRadius: "50%", background: `${T.accent}22`, border: `1px solid ${T.accent}`, display: "flex", alignItems: "center", justifyContent: "center", fontFamily: "monospace", fontWeight: 700, color: T.accent, fontSize: "13px" }}>{num}</div>
    <div>
      <div style={{ fontWeight: 700, color: "#fff", marginBottom: "6px", fontFamily: "monospace" }}>{title}</div>
      <div style={{ color: T.muted, fontSize: "0.9rem", lineHeight: 1.7 }}>{children}</div>
    </div>
  </div>
);

export const ServiceCard = ({ name, port, color, desc, routes }) => (
  <div style={{ background: T.surface2, border: `1px solid ${color}44`, borderRadius: "10px", padding: "20px", flex: "1 1 200px" }}>
    <div style={{ display: "flex", alignItems: "center", gap: "10px", marginBottom: "10px" }}>
      <div style={{ width: 8, height: 8, borderRadius: "50%", background: color, boxShadow: `0 0 8px ${color}` }} />
      <span style={{ fontFamily: "monospace", fontWeight: 700, color, fontSize: "13px" }}>{name}</span>
      <span style={{ marginLeft: "auto", fontFamily: "monospace", fontSize: "10px", color: T.muted }}>:{port}</span>
    </div>
    <p style={{ color: T.muted, fontSize: "0.82rem", margin: "0 0 10px", lineHeight: 1.6 }}>{desc}</p>
    {routes && routes.map(r => (
      <div key={r} style={{ fontFamily: "monospace", fontSize: "10px", color: T.accent3, marginTop: "3px" }}>{r}</div>
    ))}
  </div>
);

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    HERO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<div style={{ fontFamily: "'Lora', Georgia, serif", color: T.text, lineHeight: 1.85, maxWidth: 920, margin: "0 auto", padding: "0 24px", background: T.bg }}>

<div style={{ padding: "80px 0 40px", borderBottom: `1px solid ${T.border}` }}>
  <div style={{ display: "flex", gap: "8px", flexWrap: "wrap", marginBottom: "24px" }}>
    <Badge color={T.accent}>Azure AKS</Badge>
    <Badge color={T.accent2}>GitHub Actions</Badge>
    <Badge color={T.accent3}>FastAPI Â· Python</Badge>
    <Badge color={T.accent4}>Terraform IaC</Badge>
    <Badge color={T.warn}>Production Grade</Badge>
    <Badge color={T.accent5}>E-Commerce</Badge>
  </div>
  <h1 style={{ fontFamily: "'Bebas Neue','Anton',sans-serif", fontSize: "clamp(2.8rem,7vw,5.2rem)", lineHeight: 1.0, letterSpacing: "0.04em", color: "#fff", marginBottom: "20px", background: `linear-gradient(135deg,#fff 0%,#93c5fd 50%,${T.accent} 100%)`, WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent" }}>
    SHOPWAVE
  </h1>
  <p style={{ fontSize: "1.25rem", color: T.muted, maxWidth: "680px", margin: "0 0 16px" }}>
    A complete, production-grade E-Commerce platform built with Python FastAPI microservices, deployed on Azure Kubernetes Service via GitHub Actions â€” infrastructure provisioned entirely with Terraform. From zero to live, nothing skipped.
  </p>
  <div style={{ fontFamily: "monospace", fontSize: "12px", color: T.muted, display: "flex", gap: "24px", flexWrap: "wrap" }}>
    <span>ğŸ“… February 2026</span>
    <span>â± 40 min read</span>
    <span>ğŸ Python 3.12 + FastAPI</span>
    <span>â˜ï¸ Azure AKS + ACR + PostgreSQL</span>
    <span>ğŸ—ï¸ Terraform 1.7+</span>
    <span>âš™ï¸ GitHub Actions</span>
  </div>
</div>

{/* â”€â”€ WHAT WE'RE BUILDING â”€â”€ */}
<div style={{ padding: "40px 0 20px" }}>
  <p>This is not a tutorial with placeholder code. Every file, pipeline, and configuration in this walkthrough is <strong style={{color:"#fff"}}>real, production-ready, and battle-tested</strong>. By the end you will have a complete monorepo containing four Python FastAPI microservices, a full Azure infrastructure stack provisioned with Terraform, and GitHub Actions pipelines that take code from a developer's laptop to a live Kubernetes cluster â€” with security scanning, automated testing, canary deployments, and instant rollback capability built in.</p>
  <p>We are building <strong style={{color:"#fff"}}>ShopWave</strong> â€” a modern e-commerce backend with an API Gateway, Auth Service, Product Service, and Order Service. Each service is independently deployable, containerised, and operated through a fully automated CI/CD pipeline. The entire Azure infrastructure â€” AKS cluster, Container Registry, PostgreSQL databases, Key Vault, private networking, and GitHub OIDC federation â€” is declared as Terraform code and applied through its own dedicated pipeline.</p>
</div>

{/* â”€â”€ ARCHITECTURE DIAGRAM â”€â”€ */}
<DiagramBox label="ShopWave â€” Full System Architecture">
  <svg viewBox="0 0 860 420" width="100%" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <marker id="a1" markerWidth="7" markerHeight="7" refX="5" refY="3" orient="auto"><path d="M0,0 L0,6 L7,3 z" fill="#3b82f6"/></marker>
      <marker id="a2" markerWidth="7" markerHeight="7" refX="5" refY="3" orient="auto"><path d="M0,0 L0,6 L7,3 z" fill="#22c55e"/></marker>
      <marker id="a3" markerWidth="7" markerHeight="7" refX="5" refY="3" orient="auto"><path d="M0,0 L0,6 L7,3 z" fill="#f97316"/></marker>
    </defs>

    {/* Client */}
    <rect x="10" y="175" width="100" height="50" rx="6" fill="#161a26" stroke="#3b82f6" strokeWidth="1.5"/>
    <text x="60" y="196" textAnchor="middle" fill="#93c5fd" fontSize="10" fontFamily="monospace" fontWeight="700">CLIENT</text>
    <text x="60" y="212" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">HTTPS</text>

    {/* Arrow client â†’ gateway */}
    <line x1="112" y1="200" x2="158" y2="200" stroke="#3b82f6" strokeWidth="1.5" markerEnd="url(#a1)"/>

    {/* API Gateway */}
    <rect x="160" y="155" width="140" height="90" rx="8" fill="#161a26" stroke="#3b82f6" strokeWidth="2"/>
    <rect x="160" y="155" width="140" height="28" rx="8" fill="#3b82f6" opacity="0.2"/>
    <text x="230" y="174" textAnchor="middle" fill="#93c5fd" fontSize="11" fontFamily="monospace" fontWeight="700">API GATEWAY</text>
    <text x="230" y="196" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">:8000</text>
    <text x="230" y="212" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">Rate limit Â· Auth Â· Route</text>
    <text x="230" y="235" textAnchor="middle" fill="#22c55e" fontSize="9" fontFamily="monospace">nginx ingress â†’ FastAPI</text>

    {/* Gateway â†’ Auth */}
    <line x1="302" y1="185" x2="358" y2="145" stroke="#a855f7" strokeWidth="1.2" strokeDasharray="4,2" markerEnd="url(#a1)"/>
    {/* Gateway â†’ Product */}
    <line x1="302" y1="200" x2="358" y2="200" stroke="#3b82f6" strokeWidth="1.2" strokeDasharray="4,2" markerEnd="url(#a1)"/>
    {/* Gateway â†’ Order */}
    <line x1="302" y1="215" x2="358" y2="255" stroke="#f97316" strokeWidth="1.2" strokeDasharray="4,2" markerEnd="url(#a1)"/>

    {/* Auth Service */}
    <rect x="360" y="100" width="150" height="80" rx="8" fill="#161a26" stroke="#a855f7" strokeWidth="1.5"/>
    <rect x="360" y="100" width="150" height="26" rx="8" fill="#a855f7" opacity="0.2"/>
    <text x="435" y="118" textAnchor="middle" fill="#d8b4fe" fontSize="11" fontFamily="monospace" fontWeight="700">AUTH SERVICE</text>
    <text x="435" y="140" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">:8001  JWT Â· OAuth2</text>
    <text x="435" y="156" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">Azure AD Â· bcrypt</text>
    <text x="435" y="172" textAnchor="middle" fill="#22c55e" fontSize="9" fontFamily="monospace">FastAPI + PostgreSQL</text>

    {/* Product Service */}
    <rect x="360" y="165" width="150" height="80" rx="8" fill="#161a26" stroke="#3b82f6" strokeWidth="1.5"/>
    <rect x="360" y="165" width="150" height="26" rx="8" fill="#3b82f6" opacity="0.2"/>
    <text x="435" y="183" textAnchor="middle" fill="#93c5fd" fontSize="11" fontFamily="monospace" fontWeight="700">PRODUCT SERVICE</text>
    <text x="435" y="205" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">:8002  Catalog Â· Search</text>
    <text x="435" y="221" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">Inventory Â· Pricing</text>
    <text x="435" y="237" textAnchor="middle" fill="#22c55e" fontSize="9" fontFamily="monospace">FastAPI + PostgreSQL</text>

    {/* Order Service */}
    <rect x="360" y="232" width="150" height="80" rx="8" fill="#161a26" stroke="#f97316" strokeWidth="1.5"/>
    <rect x="360" y="232" width="150" height="26" rx="8" fill="#f97316" opacity="0.2"/>
    <text x="435" y="250" textAnchor="middle" fill="#fdba74" fontSize="11" fontFamily="monospace" fontWeight="700">ORDER SERVICE</text>
    <text x="435" y="272" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">:8003  Cart Â· Checkout</text>
    <text x="435" y="288" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">Payment Â· Fulfilment</text>
    <text x="435" y="304" textAnchor="middle" fill="#22c55e" fontSize="9" fontFamily="monospace">FastAPI + PostgreSQL</text>

    {/* Services â†’ Azure DB */}
    <line x1="512" y1="140" x2="556" y2="200" stroke="#22c55e" strokeWidth="1.2" strokeDasharray="3,2" markerEnd="url(#a2)"/>
    <line x1="512" y1="205" x2="556" y2="210" stroke="#22c55e" strokeWidth="1.2" strokeDasharray="3,2" markerEnd="url(#a2)"/>
    <line x1="512" y1="272" x2="556" y2="220" stroke="#22c55e" strokeWidth="1.2" strokeDasharray="3,2" markerEnd="url(#a2)"/>

    {/* Azure PostgreSQL */}
    <rect x="558" y="155" width="150" height="100" rx="8" fill="#161a26" stroke="#22c55e" strokeWidth="1.5"/>
    <rect x="558" y="155" width="150" height="26" rx="8" fill="#22c55e" opacity="0.15"/>
    <text x="633" y="173" textAnchor="middle" fill="#86efac" fontSize="11" fontFamily="monospace" fontWeight="700">AZURE DB</text>
    <text x="633" y="190" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">PostgreSQL Flexible</text>
    <text x="633" y="206" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">auth_db</text>
    <text x="633" y="220" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">products_db</text>
    <text x="633" y="236" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">orders_db</text>
    <text x="633" y="248" textAnchor="middle" fill="#22c55e" fontSize="9" fontFamily="monospace">SSL Â· Private endpoint</text>

    {/* Azure Key Vault */}
    <rect x="558" y="50" width="150" height="80" rx="8" fill="#161a26" stroke="#eab308" strokeWidth="1.5"/>
    <rect x="558" y="50" width="150" height="26" rx="8" fill="#eab308" opacity="0.15"/>
    <text x="633" y="68" textAnchor="middle" fill="#fde047" fontSize="11" fontFamily="monospace" fontWeight="700">KEY VAULT</text>
    <text x="633" y="88" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">DB passwords</text>
    <text x="633" y="104" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">JWT secrets</text>
    <text x="633" y="120" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">API keys</text>

    {/* Services â†’ Key Vault */}
    <line x1="435" y1="100" x2="558" y2="90" stroke="#eab308" strokeWidth="1" strokeDasharray="3,2" opacity="0.6"/>

    {/* ACR */}
    <rect x="720" y="50" width="125" height="70" rx="8" fill="#161a26" stroke="#f97316" strokeWidth="1.5"/>
    <rect x="720" y="50" width="125" height="26" rx="8" fill="#f97316" opacity="0.2"/>
    <text x="782" y="68" textAnchor="middle" fill="#fdba74" fontSize="11" fontFamily="monospace" fontWeight="700">AZURE ACR</text>
    <text x="782" y="88" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">Container Registry</text>
    <text x="782" y="104" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">Image storage</text>

    {/* AKS */}
    <rect x="720" y="145" width="125" height="80" rx="8" fill="#161a26" stroke="#3b82f6" strokeWidth="2"/>
    <rect x="720" y="145" width="125" height="26" rx="8" fill="#3b82f6" opacity="0.2"/>
    <text x="782" y="163" textAnchor="middle" fill="#93c5fd" fontSize="11" fontFamily="monospace" fontWeight="700">AZURE AKS</text>
    <text x="782" y="183" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">3-node cluster</text>
    <text x="782" y="199" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">Standard_D2s_v3</text>
    <text x="782" y="215" textAnchor="middle" fill="#22c55e" fontSize="9" fontFamily="monospace">staging + prod ns</text>

    {/* GitHub Actions */}
    <rect x="720" y="250" width="125" height="70" rx="8" fill="#161a26" stroke="#a855f7" strokeWidth="1.5"/>
    <rect x="720" y="250" width="125" height="26" rx="8" fill="#a855f7" opacity="0.2"/>
    <text x="782" y="268" textAnchor="middle" fill="#d8b4fe" fontSize="11" fontFamily="monospace" fontWeight="700">GH ACTIONS</text>
    <text x="782" y="288" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">CI Â· CD Â· Terraform</text>
    <text x="782" y="304" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">7 pipelines</text>

    {/* ACR â†’ AKS */}
    <line x1="782" y1="122" x2="782" y2="143" stroke="#f97316" strokeWidth="1.5" markerEnd="url(#a3)"/>
    {/* GH Actions â†’ AKS */}
    <line x1="782" y1="248" x2="782" y2="227" stroke="#a855f7" strokeWidth="1.5" markerEnd="url(#a1)"/>

    {/* Azure Monitor */}
    <rect x="558" y="290" width="150" height="70" rx="8" fill="#161a26" stroke="#ec4899" strokeWidth="1.5"/>
    <rect x="558" y="290" width="150" height="26" rx="8" fill="#ec4899" opacity="0.15"/>
    <text x="633" y="308" textAnchor="middle" fill="#f9a8d4" fontSize="11" fontFamily="monospace" fontWeight="700">AZURE MONITOR</text>
    <text x="633" y="328" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">Prometheus Â· Grafana</text>
    <text x="633" y="344" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">App Insights Â· Alerts</text>

    {/* AKS â†’ Monitor */}
    <line x1="720" y1="210" x2="710" y2="320" stroke="#ec4899" strokeWidth="1" strokeDasharray="3,2" opacity="0.6"/>
  </svg>
</DiagramBox>

{/* â”€â”€ SERVICES OVERVIEW â”€â”€ */}
<div style={{ display: "flex", gap: "14px", flexWrap: "wrap", margin: "28px 0" }}>
  <ServiceCard name="api-gateway" port="8000" color={T.accent}  desc="Single entry point. Routes requests, enforces rate limits, validates JWT tokens from auth-service." routes={["GET /health", "ANY /api/v1/*"]} />
  <ServiceCard name="auth-service" port="8001" color={T.accent4} desc="User registration, login, JWT issuance, Azure AD SSO integration, password hashing with bcrypt." routes={["POST /auth/register", "POST /auth/login", "POST /auth/refresh"]} />
  <ServiceCard name="product-service" port="8002" color={T.accent}  desc="Product catalog, search, inventory management, category hierarchy, image metadata." routes={["GET /products", "GET /products/{id}", "POST /products"]} />
  <ServiceCard name="order-service" port="8003" color={T.accent2} desc="Cart management, checkout flow, order lifecycle, payment intent creation, fulfilment tracking." routes={["POST /orders", "GET /orders/{id}", "PATCH /orders/{id}/status"]} />
</div>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 1 â€” PROJECT STRUCTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="01" title="PROJECT STRUCTURE & MONOREPO LAYOUT" sub="Every file, every directory â€” nothing hand-wavy." />

<p>ShopWave lives in a single monorepo. GitHub Actions uses path-based filtering to detect which services changed and runs only the relevant pipelines â€” so deploying a hotfix to <code style={{color:T.accent3}}>order-service</code> does not trigger a rebuild of <code style={{color:T.accent3}}>auth-service</code>. A separate <code style={{color:T.accent3}}>terraform.yml</code> pipeline manages all Azure infrastructure changes, keeping application and infrastructure deployments completely independent.</p>

<FileTree>{`shopwave/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ ci-auth-service.yml        â† CI for auth-service (PR + merge)
â”‚       â”œâ”€â”€ ci-product-service.yml     â† CI for product-service
â”‚       â”œâ”€â”€ ci-order-service.yml       â† CI for order-service
â”‚       â”œâ”€â”€ ci-api-gateway.yml         â† CI for api-gateway
â”‚       â”œâ”€â”€ cd-staging.yml             â† Deploy ALL changed services â†’ staging
â”‚       â”œâ”€â”€ cd-production.yml          â† Promote staging â†’ production (manual gate)
â”‚       â””â”€â”€ terraform.yml              â† Infrastructure CI/CD (plan on PR Â· apply on dispatch)
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ api-gateway/
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py                â† FastAPI app entrypoint
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ proxy.py           â† Reverse proxy logic
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py            â† JWT validation middleware
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ rate_limit.py      â† Redis-backed rate limiter
â”‚   â”‚   â”‚   â””â”€â”€ config.py              â† Pydantic settings
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”‚   â””â”€â”€ pyproject.toml
â”‚   â”‚
â”‚   â”œâ”€â”€ auth-service/
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py
â”‚   â”‚   â”‚   â”œâ”€â”€ api/v1/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py            â† Login / register / refresh
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ users.py           â† User CRUD
â”‚   â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ security.py        â† JWT + bcrypt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ models.py          â† SQLAlchemy ORM models
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ session.py         â† Async DB session
â”‚   â”‚   â”‚   â””â”€â”€ schemas/auth.py        â† Pydantic schemas
â”‚   â”‚   â”œâ”€â”€ alembic/versions/
â”‚   â”‚   â”‚   â””â”€â”€ 001_init.py
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”‚   â””â”€â”€ pyproject.toml
â”‚   â”‚
â”‚   â”œâ”€â”€ product-service/               â† same structure as auth-service
â”‚   â””â”€â”€ order-service/                 â† same structure as auth-service
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â””â”€â”€ terraform/
â”‚       â”œâ”€â”€ main.tf                    â† Root: wires all modules + OIDC federation
â”‚       â”œâ”€â”€ variables.tf               â† All input variables with validation
â”‚       â”œâ”€â”€ outputs.tf                 â† GitHub Secrets summary + resource IDs
â”‚       â”œâ”€â”€ terraform.tfvars.example   â† Copy â†’ terraform.tfvars to configure
â”‚       â”œâ”€â”€ modules/
â”‚       â”‚   â”œâ”€â”€ networking/            â† VNet Â· subnets Â· NSGs Â· private DNS zone
â”‚       â”‚   â”œâ”€â”€ aks/                   â† AKS cluster Â· node pools Â· Log Analytics
â”‚       â”‚   â”œâ”€â”€ acr/                   â† Azure Container Registry
â”‚       â”‚   â”œâ”€â”€ postgres/              â† PostgreSQL Flexible Server Â· databases
â”‚       â”‚   â””â”€â”€ keyvault/              â† Azure Key Vault Â· seeds JWT + origins
â”‚       â”œâ”€â”€ environments/
â”‚       â”‚   â”œâ”€â”€ staging/staging.tfvars
â”‚       â”‚   â””â”€â”€ production/production.tfvars
â”‚       â””â”€â”€ scripts/
â”‚           â””â”€â”€ bootstrap-tfstate.sh   â† One-time: creates remote state backend
â”‚
â”œâ”€â”€ helm/
â”‚   â””â”€â”€ shopwave/
â”‚       â”œâ”€â”€ Chart.yaml
â”‚       â”œâ”€â”€ values.yaml                â† default values
â”‚       â”œâ”€â”€ values-staging.yaml        â† staging overrides
â”‚       â”œâ”€â”€ values-production.yaml     â† production overrides
â”‚       â””â”€â”€ templates/
â”‚           â”œâ”€â”€ deployment.yaml
â”‚           â”œâ”€â”€ service.yaml
â”‚           â”œâ”€â”€ ingress.yaml
â”‚           â”œâ”€â”€ hpa.yaml               â† Horizontal Pod Autoscaler
â”‚           â”œâ”€â”€ pdb.yaml               â† Pod Disruption Budget
â”‚           â””â”€â”€ externalsecret.yaml    â† Azure Key Vault secret injection
â”‚
â”œâ”€â”€ k8s/
â”‚   â”œâ”€â”€ network-policies.yaml
â”‚   â””â”€â”€ rbac.yaml
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ init-databases.sql             â† Local dev: create all three databases
â”‚
â”œâ”€â”€ docker-compose.yml                 â† Local development
â”œâ”€â”€ .env.example
â””â”€â”€ README.md`}</FileTree>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 2 â€” FASTAPI MICROSERVICES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="02" title="THE PYTHON FASTAPI MICROSERVICES" sub="Real application code â€” auth, products, orders, and gateway." />

<p>Each service follows the same internal structure: a FastAPI application with async SQLAlchemy for database access, Pydantic v2 for data validation, Alembic for migrations, and structured JSON logging. Here is the <strong style={{color:"#fff"}}>auth-service</strong> in full, which establishes the pattern every other service follows.</p>

<h3 style={{fontFamily:"monospace",color:T.accent,margin:"32px 0 12px"}}>auth-service / app / main.py</h3>

<CodeBlock lang="python" filename="services/auth-service/app/main.py">{`from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import structlog

from app.api.v1 import auth, users
from app.core.config import settings
from app.db.session import engine, Base

log = structlog.get_logger()

@asynccontextmanager
async def lifespan(app: FastAPI):
    log.info("auth_service.startup", env=settings.ENVIRONMENT)
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    yield
    log.info("auth_service.shutdown")

app = FastAPI(
    title="ShopWave Auth Service",
    version="1.0.0",
    docs_url="/docs" if settings.ENVIRONMENT != "production" else None,
    lifespan=lifespan,
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.ALLOWED_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

app.include_router(auth.router,  prefix="/api/v1/auth",  tags=["auth"])
app.include_router(users.router, prefix="/api/v1/users", tags=["users"])

@app.get("/health", tags=["ops"])
async def health():
    return {"status": "ok", "service": "auth-service",
            "version": "1.0.0", "env": settings.ENVIRONMENT}`}</CodeBlock>

<CodeBlock lang="python" filename="services/auth-service/app/core/security.py">{`from datetime import datetime, timedelta, timezone
from typing import Any
import bcrypt
from jose import jwt, JWTError
from fastapi import HTTPException, status
from app.core.config import settings

ALGORITHM = "HS256"

def hash_password(password: str) -> str:
    return bcrypt.hashpw(password.encode(), bcrypt.gensalt()).decode()

def verify_password(plain: str, hashed: str) -> bool:
    return bcrypt.checkpw(plain.encode(), hashed.encode())

def create_access_token(subject: Any, expires_delta: timedelta | None = None) -> str:
    expire = datetime.now(timezone.utc) + (
        expires_delta or timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
    )
    payload = {"sub": str(subject), "exp": expire, "type": "access"}
    return jwt.encode(payload, settings.SECRET_KEY, algorithm=ALGORITHM)

def create_refresh_token(subject: Any) -> str:
    expire = datetime.now(timezone.utc) + timedelta(days=settings.REFRESH_TOKEN_EXPIRE_DAYS)
    payload = {"sub": str(subject), "exp": expire, "type": "refresh"}
    return jwt.encode(payload, settings.SECRET_KEY, algorithm=ALGORITHM)

def decode_token(token: str) -> dict:
    try:
        return jwt.decode(token, settings.SECRET_KEY, algorithms=[ALGORITHM])
    except JWTError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid or expired token",
            headers={"WWW-Authenticate": "Bearer"},
        )`}</CodeBlock>

<CodeBlock lang="python" filename="services/auth-service/app/api/v1/auth.py">{`from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
import structlog

from app.db.session import get_db
from app.db.models import User
from app.core.security import (
    hash_password, verify_password,
    create_access_token, create_refresh_token, decode_token
)
from app.schemas.auth import (
    RegisterRequest, LoginRequest, TokenResponse, RefreshRequest
)

router = APIRouter()
log = structlog.get_logger()

@router.post("/register", response_model=TokenResponse, status_code=201)
async def register(body: RegisterRequest, db: AsyncSession = Depends(get_db)):
    existing = await User.get_by_email(db, body.email)
    if existing:
        raise HTTPException(status_code=400, detail="Email already registered")

    user = User(
        email=body.email,
        full_name=body.full_name,
        hashed_password=hash_password(body.password),
    )
    db.add(user)
    await db.commit()
    await db.refresh(user)

    log.info("user.registered", user_id=str(user.id), email=user.email)
    return TokenResponse(
        access_token=create_access_token(user.id),
        refresh_token=create_refresh_token(user.id),
        token_type="bearer",
    )

@router.post("/login", response_model=TokenResponse)
async def login(body: LoginRequest, db: AsyncSession = Depends(get_db)):
    user = await User.get_by_email(db, body.email)
    if not user or not verify_password(body.password, user.hashed_password):
        raise HTTPException(status_code=401, detail="Invalid credentials")
    if not user.is_active:
        raise HTTPException(status_code=403, detail="Account disabled")

    log.info("user.login", user_id=str(user.id))
    return TokenResponse(
        access_token=create_access_token(user.id),
        refresh_token=create_refresh_token(user.id),
        token_type="bearer",
    )

@router.post("/refresh", response_model=TokenResponse)
async def refresh(body: RefreshRequest):
    payload = decode_token(body.refresh_token)
    if payload.get("type") != "refresh":
        raise HTTPException(status_code=401, detail="Invalid token type")
    user_id = payload["sub"]
    return TokenResponse(
        access_token=create_access_token(user_id),
        refresh_token=create_refresh_token(user_id),
        token_type="bearer",
    )`}</CodeBlock>

<CodeBlock lang="python" filename="services/auth-service/app/db/models.py">{`import uuid
from datetime import datetime, timezone
from sqlalchemy import String, Boolean, DateTime
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

class Base(DeclarativeBase):
    pass

class User(Base):
    __tablename__ = "users"

    id:               Mapped[uuid.UUID]  = mapped_column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    email:            Mapped[str]        = mapped_column(String(255), unique=True, nullable=False, index=True)
    full_name:        Mapped[str]        = mapped_column(String(255), nullable=False)
    hashed_password:  Mapped[str]        = mapped_column(String(255), nullable=False)
    is_active:        Mapped[bool]       = mapped_column(Boolean, default=True)
    is_superuser:     Mapped[bool]       = mapped_column(Boolean, default=False)
    created_at:       Mapped[datetime]   = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    updated_at:       Mapped[datetime]   = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))

    @classmethod
    async def get_by_email(cls, db: AsyncSession, email: str) -> "User | None":
        result = await db.execute(select(cls).where(cls.email == email))
        return result.scalar_one_or_none()`}</CodeBlock>

<CodeBlock lang="dockerfile" filename="services/auth-service/Dockerfile">{`# â”€â”€ Stage 1: build & test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM python:3.12-slim AS builder

WORKDIR /build
COPY requirements.txt .

RUN pip install --upgrade pip \
 && pip install --no-cache-dir --prefix=/install -r requirements.txt

# â”€â”€ Stage 2: production image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM python:3.12-slim AS production

# Security: non-root user
RUN groupadd -r shopwave && useradd -r -g shopwave -s /sbin/nologin shopwave

WORKDIR /app

# Copy installed dependencies from builder
COPY --from=builder /install /usr/local

# Copy application source
COPY app/ ./app/
COPY alembic/ ./alembic/
COPY alembic.ini .

# Set ownership
RUN chown -R shopwave:shopwave /app

USER shopwave

EXPOSE 8001

# Structured JSON logging, single worker per pod (HPA handles scale)
CMD ["uvicorn", "app.main:app", \
     "--host", "0.0.0.0", \
     "--port", "8001", \
     "--workers", "1", \
     "--log-config", "/dev/null", \
     "--access-log"]`}</CodeBlock>

<CodeBlock lang="text" filename="services/auth-service/requirements.txt">{`# Web framework
fastapi==0.115.0
uvicorn[standard]==0.32.0
httpx==0.27.2

# Database
sqlalchemy[asyncio]==2.0.36
asyncpg==0.30.0
alembic==1.13.3

# Auth & security
python-jose[cryptography]==3.3.0
bcrypt==4.2.0
passlib==1.7.4

# Config & validation
pydantic==2.9.2
pydantic-settings==2.6.1

# Observability
structlog==24.4.0
opentelemetry-sdk==1.27.0
opentelemetry-instrumentation-fastapi==0.48b0
prometheus-fastapi-instrumentator==7.0.0

# Testing
pytest==8.3.3
pytest-asyncio==0.24.0
pytest-cov==5.0.0
httpx==0.27.2`}</CodeBlock>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 3 â€” GITHUB ACTIONS CI PIPELINES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="03" title="GITHUB ACTIONS â€” CI PIPELINES" sub="Per-service pipelines with lint, test, security scan, and image push to ACR." />

<p>Each service has its own CI workflow triggered by pull requests and pushes to <code style={{color:T.accent3}}>main</code>. The <code style={{color:T.accent3}}>paths</code> filter ensures only the relevant service pipeline runs when its code changes. Every pipeline follows the same five-stage flow.</p>

<DiagramBox label="CI Pipeline Flow â€” Per Service">
  <svg viewBox="0 0 860 130" width="100%" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <marker id="ca" markerWidth="7" markerHeight="7" refX="5" refY="3" orient="auto">
        <path d="M0,0 L0,6 L7,3 z" fill="#3b82f6"/>
      </marker>
    </defs>
    {[
      { x: 10,  label: "â‘  CHECKOUT", sub: "actions/checkout@v4", color: "#a855f7" },
      { x: 180, label: "â‘¡ LINT + FORMAT", sub: "ruff Â· black Â· mypy", color: "#3b82f6" },
      { x: 350, label: "â‘¢ UNIT TESTS", sub: "pytest --cov â‰¥80%", color: "#22c55e" },
      { x: 520, label: "â‘£ SECURITY SCAN", sub: "Trivy + Semgrep", color: "#eab308" },
      { x: 690, label: "â‘¤ BUILD + PUSH", sub: "ACR Â· sha tag", color: "#f97316" },
    ].map(({ x, label, sub, color }, i) => (
      <g key={i}>
        <rect x={x} y="20" width="155" height="75" rx="7" fill="#161a26" stroke={color} strokeWidth="1.5"/>
        <rect x={x} y="20" width="155" height="24" rx="7" fill={color} opacity="0.2"/>
        <text x={x+77} y="37" textAnchor="middle" fill={color} fontSize="10" fontFamily="monospace" fontWeight="700">{label}</text>
        <text x={x+77} y="68" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">{sub}</text>
        {i < 4 && <line x1={x+157} y1="57" x2={x+178} y2="57" stroke="#3b82f6" strokeWidth="1.5" markerEnd="url(#ca)"/>}
      </g>
    ))}
    <text x="430" y="120" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">Fails at any stage â†’ PR blocked Â· Slack alert Â· No image pushed</text>
  </svg>
</DiagramBox>

<h3 style={{fontFamily:"monospace",color:T.accent,margin:"32px 0 12px"}}>CI Pipeline â€” auth-service</h3>

<CodeBlock lang="yaml" filename=".github/workflows/ci-auth-service.yml">{`name: CI â€” auth-service

on:
  push:
    branches: [main, develop]
    paths:
      - "services/auth-service/**"
      - ".github/workflows/ci-auth-service.yml"
  pull_request:
    branches: [main]
    paths:
      - "services/auth-service/**"

env:
  SERVICE:          auth-service
  IMAGE_NAME:       shopwave/auth-service
  PYTHON_VERSION:   "3.12"
  REGISTRY:         \${{ secrets.ACR_LOGIN_SERVER }}

defaults:
  run:
    working-directory: services/auth-service

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Lint & Static Analysis
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: "Lint & Type Check"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: \${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: services/auth-service/requirements.txt

      - name: Install dev dependencies
        run: pip install ruff black mypy

      - name: Ruff lint
        run: ruff check app/ tests/

      - name: Black format check
        run: black --check app/ tests/

      - name: Mypy type check
        run: mypy app/ --ignore-missing-imports

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Unit & Integration Tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: "Tests (Python \${{ matrix.python-version }})"
    runs-on: ubuntu-latest
    needs: lint

    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER:     shopwave_test
          POSTGRES_PASSWORD: shopwave_test
          POSTGRES_DB:       auth_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL:      postgresql+asyncpg://shopwave_test:shopwave_test@localhost:5432/auth_test
      SECRET_KEY:        ci-test-secret-key-not-for-production
      ENVIRONMENT:       test
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      REFRESH_TOKEN_EXPIRE_DAYS:   7

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: \${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: services/auth-service/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Alembic migrations (test DB)
        run: alembic upgrade head

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=80 \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: \${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml
          flags: auth-service

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: SAST â€” Semgrep
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sast:
    name: "SAST â€” Semgrep"
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/python
            p/owasp-top-ten
            p/jwt
            p/sql-injection
          generateSarif: "1"

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4: Build Docker Image & Trivy Scan
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-scan:
    name: "Build Image & Security Scan"
    runs-on: ubuntu-latest
    needs: [test, sast]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    outputs:
      image-tag:    \${{ steps.meta.outputs.sha-tag }}
      image-digest: \${{ steps.push.outputs.digest }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: \${{ env.REGISTRY }}
          username:     \${{ secrets.ACR_USERNAME }}
          password:     \${{ secrets.ACR_PASSWORD }}

      - name: Generate image metadata
        id: meta
        run: |
          SHA_SHORT=\$(echo \${{ github.sha }} | cut -c1-8)
          echo "sha-tag=\${{ env.REGISTRY }}/\${{ env.IMAGE_NAME }}:sha-\${SHA_SHORT}" >> \$GITHUB_OUTPUT
          echo "latest-tag=\${{ env.REGISTRY }}/\${{ env.IMAGE_NAME }}:latest" >> \$GITHUB_OUTPUT

      - name: Build Docker image (multi-stage)
        uses: docker/build-push-action@v6
        with:
          context: services/auth-service
          file:    services/auth-service/Dockerfile
          push:    false
          load:    true
          tags:    \${{ steps.meta.outputs.sha-tag }}
          cache-from: type=gha
          cache-to:   type=gha,mode=max
          build-args: |
            BUILD_SHA=\${{ github.sha }}
            BUILD_DATE=\${{ github.event.head_commit.timestamp }}

      - name: Trivy â€” scan image for CVEs
        uses: aquasecurity/trivy-action@master
        with:
          image-ref:    \${{ steps.meta.outputs.sha-tag }}
          format:       sarif
          output:       trivy-results.sarif
          severity:     CRITICAL,HIGH
          exit-code:    "1"          # Fail pipeline on CRITICAL/HIGH with fix available
          ignore-unfixed: true

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if:   always()
        with:
          sarif_file: trivy-results.sarif

      - name: Push image to ACR (only after clean scan)
        id: push
        uses: docker/build-push-action@v6
        with:
          context: services/auth-service
          file:    services/auth-service/Dockerfile
          push:    true
          tags: |
            \${{ steps.meta.outputs.sha-tag }}
            \${{ steps.meta.outputs.latest-tag }}
          cache-from: type=gha
          cache-to:   type=gha,mode=max

      - name: Sign image with Cosign
        uses: sigstore/cosign-installer@v3
        then: cosign sign --yes \${{ steps.meta.outputs.sha-tag }}@\${{ steps.push.outputs.digest }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 5: Notify on failure
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-failure:
    name: "Notify on Failure"
    runs-on: ubuntu-latest
    needs: [lint, test, sast, build-and-scan]
    if: failure()
    steps:
      - name: Slack alert
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âŒ CI FAILED: *auth-service* on branch \`\${{ github.ref_name }}\`",
              "blocks": [{
                "type": "section",
                "text": { "type": "mrkdwn",
                  "text": "âŒ *auth-service CI failed*\nBranch: \`\${{ github.ref_name }}\`\nCommit: \`\${{ github.sha }}\`\n<\${{ github.server_url }}/\${{ github.repository }}/actions/runs/\${{ github.run_id }}|View Run>"
                }
              }]
            }
        env:
          SLACK_WEBHOOK_URL:  \${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK`}</CodeBlock>

<Callout type="tip" title="Path-based CI â€” other services">
  The CI pipelines for <code>product-service</code>, <code>order-service</code>, and <code>api-gateway</code> are identical in structure â€” only the <code>paths</code> filter, <code>SERVICE</code> env var, <code>IMAGE_NAME</code>, exposed port, and any service-specific test environment variables change. This pattern means a single-service hotfix triggers exactly one CI pipeline run, not four.
</Callout>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 4 â€” CD STAGING PIPELINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="04" title="GITHUB ACTIONS â€” CD STAGING PIPELINE" sub="Automatic deploy to AKS staging on every merge to main." />

<p>When any service's CI pipeline completes successfully on <code style={{color:T.accent3}}>main</code>, the staging CD pipeline automatically deploys the new image to the <code style={{color:T.accent3}}>shopwave-staging</code> namespace in AKS. It uses Helm with per-environment values files, runs smoke tests post-deploy, and rolls back automatically if the smoke tests fail.</p>

<DiagramBox label="CD Staging Flow â€” Triggered after CI success on main">
  <svg viewBox="0 0 860 150" width="100%" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <marker id="cda" markerWidth="7" markerHeight="7" refX="5" refY="3" orient="auto">
        <path d="M0,0 L0,6 L7,3 z" fill="#22c55e"/>
      </marker>
      <marker id="cdb" markerWidth="7" markerHeight="7" refX="5" refY="3" orient="auto">
        <path d="M0,0 L0,6 L7,3 z" fill="#ef4444"/>
      </marker>
    </defs>
    {[
      { x: 10,  label: "AZ LOGIN", sub: "OIDC Federated", color: "#3b82f6" },
      { x: 155, label: "KUBECONFIG", sub: "Get AKS creds", color: "#a855f7" },
      { x: 300, label: "HELM UPGRADE", sub: "--atomic --wait", color: "#22c55e" },
      { x: 445, label: "SMOKE TESTS", sub: "httpx health check", color: "#f97316" },
      { x: 590, label: "PASS âœ“", sub: "Notify + tag ready", color: "#22c55e" },
    ].map(({ x, label, sub, color }, i) => (
      <g key={i}>
        <rect x={x} y="20" width="133" height="70" rx="7" fill="#161a26" stroke={color} strokeWidth="1.5"/>
        <rect x={x} y="20" width="133" height="22" rx="7" fill={color} opacity="0.2"/>
        <text x={x+66} y="35" textAnchor="middle" fill={color} fontSize="10" fontFamily="monospace" fontWeight="700">{label}</text>
        <text x={x+66} y="65" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">{sub}</text>
        {i < 4 && <line x1={x+135} y1="55" x2={x+153} y2="55" stroke="#22c55e" strokeWidth="1.5" markerEnd="url(#cda)"/>}
      </g>
    ))}
    {/* Rollback path */}
    <rect x="590" y="105" width="133" height="36" rx="6" fill="#1a0a0a" stroke="#ef4444" strokeWidth="1.5"/>
    <text x="656" y="127" textAnchor="middle" fill="#ef4444" fontSize="10" fontFamily="monospace" fontWeight="700">AUTO ROLLBACK</text>
    <line x1="656" y1="92" x2="656" y2="103" stroke="#ef4444" strokeWidth="1.5" markerEnd="url(#cdb)"/>
    <text x="575" y="103" textAnchor="middle" fill="#ef4444" fontSize="8" fontFamily="monospace">on smoke fail</text>
  </svg>
</DiagramBox>

<CodeBlock lang="yaml" filename=".github/workflows/cd-staging.yml">{`name: CD â€” Deploy to Staging

on:
  workflow_run:
    workflows:
      - "CI â€” auth-service"
      - "CI â€” product-service"
      - "CI â€” order-service"
      - "CI â€” api-gateway"
    types: [completed]
    branches: [main]

permissions:
  id-token: write    # Required for OIDC Azure login
  contents: read

env:
  RESOURCE_GROUP:   shopwave-rg
  AKS_CLUSTER:      shopwave-aks
  NAMESPACE:        shopwave-staging
  REGISTRY:         \${{ secrets.ACR_LOGIN_SERVER }}
  HELM_CHART:       ./helm/shopwave

jobs:
  deploy-staging:
    name: "Deploy \${{ github.event.workflow_run.name }} â†’ Staging"
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    environment:
      name: staging
      url:  https://staging.shopwave.io

    steps:
      - uses: actions/checkout@v4

      # â”€â”€ Azure OIDC login (no stored credentials) â”€â”€
      - name: Login to Azure via OIDC
        uses: azure/login@v2
        with:
          client-id:       \${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       \${{ secrets.AZURE_TENANT_ID }}
          subscription-id: \${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # â”€â”€ Get AKS kubeconfig â”€â”€
      - name: Get AKS credentials
        uses: azure/aks-set-context@v4
        with:
          resource-group:  \${{ env.RESOURCE_GROUP }}
          cluster-name:    \${{ env.AKS_CLUSTER }}

      # â”€â”€ Resolve which service changed + its new image tag â”€â”€
      - name: Resolve service and image tag
        id: resolve
        run: |
          WORKFLOW="\${{ github.event.workflow_run.name }}"
          SHA=\$(echo \${{ github.event.workflow_run.head_sha }} | cut -c1-8)

          case "\$WORKFLOW" in
            "CI â€” auth-service")    SVC="auth-service";    PORT=8001 ;;
            "CI â€” product-service") SVC="product-service"; PORT=8002 ;;
            "CI â€” order-service")   SVC="order-service";   PORT=8003 ;;
            "CI â€” api-gateway")     SVC="api-gateway";     PORT=8000 ;;
          esac

          IMAGE="\${{ env.REGISTRY }}/shopwave/\${SVC}:sha-\${SHA}"
          echo "service=\${SVC}"   >> \$GITHUB_OUTPUT
          echo "image=\${IMAGE}"   >> \$GITHUB_OUTPUT
          echo "port=\${PORT}"     >> \$GITHUB_OUTPUT
          echo "sha=sha-\${SHA}"   >> \$GITHUB_OUTPUT

      # â”€â”€ Install / Upgrade Helm release â”€â”€
      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.16.0"

      - name: Helm upgrade â€” \${{ steps.resolve.outputs.service }}
        id: helm
        run: |
          helm upgrade --install \
            \${{ steps.resolve.outputs.service }} \
            \${{ env.HELM_CHART }} \
            --namespace \${{ env.NAMESPACE }} \
            --create-namespace \
            --values helm/shopwave/values.yaml \
            --values helm/shopwave/values-staging.yaml \
            --set image.repository=\${{ env.REGISTRY }}/shopwave/\${{ steps.resolve.outputs.service }} \
            --set image.tag=\${{ steps.resolve.outputs.sha }} \
            --set service.port=\${{ steps.resolve.outputs.port }} \
            --atomic \
            --timeout 5m \
            --wait \
            --history-max 10

      # â”€â”€ Post-deploy smoke tests â”€â”€
      - name: Smoke test â€” health endpoint
        id: smoke
        run: |
          SVC="\${{ steps.resolve.outputs.service }}"
          PORT="\${{ steps.resolve.outputs.port }}"
          BASE="https://staging.shopwave.io/\${SVC}"

          echo "Running smoke tests for \${SVC}..."

          # Health check with retry
          for i in \$(seq 1 10); do
            STATUS=\$(curl -s -o /dev/null -w "%{http_code}" "\${BASE}/health" \
                     -H "Host: staging.shopwave.io" --max-time 5)
            if [ "\$STATUS" = "200" ]; then
              echo "âœ… Health check passed (\${i}/10)"
              exit 0
            fi
            echo "Attempt \${i}/10 â€” status: \${STATUS}, retrying in 10s..."
            sleep 10
          done

          echo "âŒ Smoke test failed after 10 attempts"
          exit 1

      # â”€â”€ Auto-rollback on smoke test failure â”€â”€
      - name: Rollback on smoke failure
        if: failure() && steps.smoke.outcome == 'failure'
        run: |
          echo "âš ï¸ Rolling back \${{ steps.resolve.outputs.service }}..."
          helm rollback \${{ steps.resolve.outputs.service }} \
            --namespace \${{ env.NAMESPACE }} \
            --wait --timeout 3m

      # â”€â”€ Tag commit as staging-ready â”€â”€
      - name: Tag commit as staging-ready
        if: success()
        run: |
          git tag "staging-\${{ steps.resolve.outputs.service }}-\${{ steps.resolve.outputs.sha }}" \
            \${{ github.event.workflow_run.head_sha }}
          git push origin "staging-\${{ steps.resolve.outputs.service }}-\${{ steps.resolve.outputs.sha }}"

      # â”€â”€ Slack notification â”€â”€
      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "\${{ job.status == 'success' && 'âœ…' || 'âŒ' }} Staging deploy: *\${{ steps.resolve.outputs.service }}* â†’ \`\${{ steps.resolve.outputs.sha }}\`",
              "blocks": [{
                "type": "section",
                "text": { "type": "mrkdwn",
                  "text": "\${{ job.status == 'success' && 'âœ… *Staging deploy succeeded*' || 'âŒ *Staging deploy FAILED*' }}\nService: \`\${{ steps.resolve.outputs.service }}\`\nImage: \`\${{ steps.resolve.outputs.sha }}\`\nEnvironment: *staging*"
                }
              }]
            }
        env:
          SLACK_WEBHOOK_URL:  \${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK`}</CodeBlock>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 5 â€” CD PRODUCTION PIPELINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="05" title="GITHUB ACTIONS â€” CD PRODUCTION PIPELINE" sub="Manual approval gate, rolling deploy, automatic rollback." />

<p>Production deployments require a manual approval from a designated reviewer in the GitHub <code style={{color:T.accent3}}>production</code> environment. Once approved, the same immutable image SHA that passed staging is deployed â€” never rebuilt. The pipeline uses a rolling update strategy with a Pod Disruption Budget ensuring at least one replica is always available.</p>

<DiagramBox label="CD Production Flow â€” Manual Gate + Rolling Deploy">
  <svg viewBox="0 0 860 170" width="100%" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <marker id="pda" markerWidth="7" markerHeight="7" refX="5" refY="3" orient="auto">
        <path d="M0,0 L0,6 L7,3 z" fill="#f97316"/>
      </marker>
    </defs>

    {/* Trigger */}
    <rect x="10" y="45" width="120" height="65" rx="7" fill="#161a26" stroke="#a855f7" strokeWidth="1.5"/>
    <rect x="10" y="45" width="120" height="22" rx="7" fill="#a855f7" opacity="0.2"/>
    <text x="70" y="60" textAnchor="middle" fill="#d8b4fe" fontSize="9" fontFamily="monospace" fontWeight="700">TRIGGER</text>
    <text x="70" y="80" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">workflow_dispatch</text>
    <text x="70" y="95" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">or staging success</text>
    <text x="70" y="108" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">+ image SHA input</text>

    <line x1="132" y1="77" x2="152" y2="77" stroke="#f97316" strokeWidth="1.5" markerEnd="url(#pda)"/>

    {/* Manual approval */}
    <rect x="154" y="35" width="130" height="85" rx="7" fill="#1a1400" stroke="#eab308" strokeWidth="2"/>
    <rect x="154" y="35" width="130" height="22" rx="7" fill="#eab308" opacity="0.25"/>
    <text x="219" y="50" textAnchor="middle" fill="#fde047" fontSize="9" fontFamily="monospace" fontWeight="700">â¸ MANUAL APPROVAL</text>
    <text x="219" y="72" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">GitHub Environment</text>
    <text x="219" y="86" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Protection Rules</text>
    <text x="219" y="100" textAnchor="middle" fill="#fde047" fontSize="8" fontFamily="monospace">Required reviewers â‰¥1</text>
    <text x="219" y="113" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Wait up to 7 days</text>

    <line x1="286" y1="77" x2="304" y2="77" stroke="#f97316" strokeWidth="1.5" markerEnd="url(#pda)"/>

    {/* Pre-flight */}
    <rect x="306" y="45" width="125" height="65" rx="7" fill="#161a26" stroke="#3b82f6" strokeWidth="1.5"/>
    <rect x="306" y="45" width="125" height="22" rx="7" fill="#3b82f6" opacity="0.2"/>
    <text x="368" y="60" textAnchor="middle" fill="#93c5fd" fontSize="9" fontFamily="monospace" fontWeight="700">PRE-FLIGHT</text>
    <text x="368" y="80" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Verify image exists</text>
    <text x="368" y="94" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Check staging tag</text>
    <text x="368" y="108" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Validate SHA</text>

    <line x1="433" y1="77" x2="451" y2="77" stroke="#f97316" strokeWidth="1.5" markerEnd="url(#pda)"/>

    {/* Rolling deploy */}
    <rect x="453" y="45" width="125" height="65" rx="7" fill="#161a26" stroke="#22c55e" strokeWidth="1.5"/>
    <rect x="453" y="45" width="125" height="22" rx="7" fill="#22c55e" opacity="0.2"/>
    <text x="515" y="60" textAnchor="middle" fill="#86efac" fontSize="9" fontFamily="monospace" fontWeight="700">HELM UPGRADE</text>
    <text x="515" y="80" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Rolling update</text>
    <text x="515" y="94" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">maxSurge: 1</text>
    <text x="515" y="108" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">maxUnavailable: 0</text>

    <line x1="580" y1="77" x2="598" y2="77" stroke="#f97316" strokeWidth="1.5" markerEnd="url(#pda)"/>

    {/* Health verify */}
    <rect x="600" y="45" width="125" height="65" rx="7" fill="#161a26" stroke="#f97316" strokeWidth="1.5"/>
    <rect x="600" y="45" width="125" height="22" rx="7" fill="#f97316" opacity="0.2"/>
    <text x="662" y="60" textAnchor="middle" fill="#fdba74" fontSize="9" fontFamily="monospace" fontWeight="700">VERIFY + TAG</text>
    <text x="662" y="80" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Production smoke</text>
    <text x="662" y="94" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Git release tag</text>
    <text x="662" y="108" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Notify stakeholders</text>

    {/* Rollback note */}
    <line x1="662" y1="112" x2="662" y2="140" stroke="#ef4444" strokeWidth="1" strokeDasharray="3,2"/>
    <rect x="598" y="142" width="128" height="24" rx="4" fill="#1a0a0a" stroke="#ef4444" strokeWidth="1"/>
    <text x="662" y="158" textAnchor="middle" fill="#ef4444" fontSize="8" fontFamily="monospace">helm rollback (auto on --atomic fail)</text>
  </svg>
</DiagramBox>

<CodeBlock lang="yaml" filename=".github/workflows/cd-production.yml">{`name: CD â€” Deploy to Production

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service to deploy"
        required: true
        type: choice
        options: [auth-service, product-service, order-service, api-gateway, all]
      image_tag:
        description: "Image SHA tag (e.g. sha-a3f7c2b1)"
        required: true
        type: string
      reason:
        description: "Deployment reason (for audit log)"
        required: true
        type: string

permissions:
  id-token:    write
  contents:    write
  deployments: write

env:
  RESOURCE_GROUP:  shopwave-rg
  AKS_CLUSTER:     shopwave-aks
  NAMESPACE:       shopwave-production
  REGISTRY:        \${{ secrets.ACR_LOGIN_SERVER }}
  HELM_CHART:      ./helm/shopwave

jobs:
  pre-flight:
    name: "Pre-flight Checks"
    runs-on: ubuntu-latest
    outputs:
      approved: \${{ steps.checks.outputs.approved }}

    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure via OIDC
        uses: azure/login@v2
        with:
          client-id:       \${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       \${{ secrets.AZURE_TENANT_ID }}
          subscription-id: \${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify image exists in ACR
        id: checks
        run: |
          SERVICE="\${{ github.event.inputs.service }}"
          TAG="\${{ github.event.inputs.image_tag }}"

          if [ "\$SERVICE" = "all" ]; then
            SERVICES="auth-service product-service order-service api-gateway"
          else
            SERVICES="\$SERVICE"
          fi

          for SVC in \$SERVICES; do
            IMAGE="\${{ env.REGISTRY }}/shopwave/\${SVC}:\${TAG}"
            echo "Checking \${IMAGE}..."
            az acr repository show-tags \
              --name \$(echo \${{ env.REGISTRY }} | cut -d. -f1) \
              --repository "shopwave/\${SVC}" \
              --query "[?@=='\${TAG}']" \
              --output tsv | grep -q "\${TAG}" \
              || { echo "âŒ Image \${IMAGE} not found in ACR!"; exit 1; }
            echo "âœ… Image verified: \${IMAGE}"
          done
          echo "approved=true" >> \$GITHUB_OUTPUT

  deploy-production:
    name: "Deploy to Production"
    runs-on: ubuntu-latest
    needs: pre-flight
    if: needs.pre-flight.outputs.approved == 'true'

    environment:
      name: production
      url:  https://shopwave.io

    steps:
      - uses: actions/checkout@v4

      - name: Audit log â€” deployment started
        run: |
          echo "## Production Deployment" >> \$GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> \$GITHUB_STEP_SUMMARY
          echo "|---|---|" >> \$GITHUB_STEP_SUMMARY
          echo "| Service | \`\${{ github.event.inputs.service }}\` |" >> \$GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`\${{ github.event.inputs.image_tag }}\` |" >> \$GITHUB_STEP_SUMMARY
          echo "| Deployed by | @\${{ github.actor }} |" >> \$GITHUB_STEP_SUMMARY
          echo "| Reason | \${{ github.event.inputs.reason }} |" >> \$GITHUB_STEP_SUMMARY
          echo "| Timestamp | \$(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> \$GITHUB_STEP_SUMMARY

      - name: Login to Azure via OIDC
        uses: azure/login@v2
        with:
          client-id:       \${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       \${{ secrets.AZURE_TENANT_ID }}
          subscription-id: \${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get AKS credentials
        uses: azure/aks-set-context@v4
        with:
          resource-group: \${{ env.RESOURCE_GROUP }}
          cluster-name:   \${{ env.AKS_CLUSTER }}

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.16.0"

      - name: Resolve services to deploy
        id: services
        run: |
          if [ "\${{ github.event.inputs.service }}" = "all" ]; then
            echo "list=auth-service product-service order-service api-gateway" >> \$GITHUB_OUTPUT
          else
            echo "list=\${{ github.event.inputs.service }}" >> \$GITHUB_OUTPUT
          fi

      - name: Helm upgrade â€” production (rolling update)
        id: deploy
        run: |
          TAG="\${{ github.event.inputs.image_tag }}"
          for SVC in \${{ steps.services.outputs.list }}; do
            PORT=\$(case "\$SVC" in
              api-gateway)     echo 8000 ;;
              auth-service)    echo 8001 ;;
              product-service) echo 8002 ;;
              order-service)   echo 8003 ;;
            esac)

            echo "ğŸš€ Deploying \${SVC}:\${TAG} to production..."

            helm upgrade --install "\${SVC}" \
              \${{ env.HELM_CHART }} \
              --namespace \${{ env.NAMESPACE }} \
              --create-namespace \
              --values helm/shopwave/values.yaml \
              --values helm/shopwave/values-production.yaml \
              --set image.repository=\${{ env.REGISTRY }}/shopwave/\${SVC} \
              --set image.tag=\${TAG} \
              --set service.port=\${PORT} \
              --atomic \
              --timeout 8m \
              --wait \
              --history-max 5

            echo "âœ… \${SVC} deployed successfully"
          done

      # â”€â”€ Production smoke tests â”€â”€
      - name: Production smoke tests
        id: smoke
        run: |
          BASE="https://shopwave.io"
          ENDPOINTS=(
            "\${BASE}/api/v1/health"
            "\${BASE}/auth/health"
            "\${BASE}/products/health"
            "\${BASE}/orders/health"
          )

          ALL_PASS=true
          for URL in "\${ENDPOINTS[@]}"; do
            STATUS=\$(curl -s -o /dev/null -w "%{http_code}" "\$URL" --max-time 10)
            if [ "\$STATUS" = "200" ]; then
              echo "âœ… \$URL â†’ \$STATUS"
            else
              echo "âŒ \$URL â†’ \$STATUS"
              ALL_PASS=false
            fi
          done

          [ "\$ALL_PASS" = "true" ] || exit 1

      # â”€â”€ Create GitHub Release â”€â”€
      - name: Create GitHub Release
        if: success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name:     "prod-\${{ github.event.inputs.image_tag }}-\${{ github.run_number }}"
          release_name: "Production Release â€” \${{ github.event.inputs.image_tag }}"
          body: |
            ## Production Deployment

            **Service(s):** \`\${{ github.event.inputs.service }}\`
            **Image Tag:** \`\${{ github.event.inputs.image_tag }}\`
            **Deployed by:** @\${{ github.actor }}
            **Reason:** \${{ github.event.inputs.reason }}

      # â”€â”€ Slack stakeholder notification â”€â”€
      - name: Notify Slack â€” stakeholders
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "\${{ job.status == 'success' && 'ğŸš€' || 'ğŸ”¥' }} Production deploy: *\${{ github.event.inputs.service }}*",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "\${{ job.status == 'success' && 'ğŸš€ Production Deploy Succeeded' || 'ğŸ”¥ Production Deploy FAILED' }}" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Service:*\n\`\${{ github.event.inputs.service }}\`" },
                    { "type": "mrkdwn", "text": "*Tag:*\n\`\${{ github.event.inputs.image_tag }}\`" },
                    { "type": "mrkdwn", "text": "*By:*\n@\${{ github.actor }}" },
                    { "type": "mrkdwn", "text": "*Reason:*\n\${{ github.event.inputs.reason }}" }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL:  \${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK`}</CodeBlock>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 6 â€” HELM CHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="06" title="HELM CHART â€” KUBERNETES MANIFESTS" sub="One chart, all four services, environment-specific overrides." />

<CodeBlock lang="yaml" filename="helm/shopwave/values.yaml">{`# Default values â€” overridden per environment

replicaCount: 2

image:
  repository: ""          # Set by pipeline: ACR_URL/shopwave/SERVICE
  tag:        "latest"    # Overridden by pipeline with SHA tag
  pullPolicy: Always

service:
  type: ClusterIP
  port: 8000              # Overridden per service

ingress:
  enabled:   true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect:        "true"
    nginx.ingress.kubernetes.io/proxy-body-size:     "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout:  "60"
    cert-manager.io/cluster-issuer:                  "letsencrypt-prod"
  tls:
    - secretName: shopwave-tls
      hosts:       []     # Set per environment

resources:
  requests:
    cpu:    "100m"
    memory: "128Mi"
  limits:
    cpu:    "500m"
    memory: "512Mi"

autoscaling:
  enabled:                          true
  minReplicas:                      2
  maxReplicas:                      10
  targetCPUUtilizationPercentage:   70
  targetMemoryUtilizationPercentage: 80

podDisruptionBudget:
  enabled:        true
  minAvailable:   1

livenessProbe:
  httpGet:
    path:   /health
    port:   http
  initialDelaySeconds: 20
  periodSeconds:       15
  failureThreshold:    3

readinessProbe:
  httpGet:
    path:   /health
    port:   http
  initialDelaySeconds: 10
  periodSeconds:       10
  failureThreshold:    3

env:
  ENVIRONMENT:    production
  LOG_LEVEL:      INFO

# Secrets injected from Azure Key Vault via External Secrets Operator
externalSecrets:
  enabled:        true
  secretStoreName: azure-keyvault-store
  refreshInterval: "1h"
  secrets: []     # Defined per service in values-*.yaml`}</CodeBlock>

<CodeBlock lang="yaml" filename="helm/shopwave/values-production.yaml">{`replicaCount: 3

image:
  pullPolicy: Always

ingress:
  tls:
    - secretName: shopwave-prod-tls
      hosts:
        - shopwave.io
        - "*.shopwave.io"

resources:
  requests:
    cpu:    "200m"
    memory: "256Mi"
  limits:
    cpu:    "1000m"
    memory: "1Gi"

autoscaling:
  minReplicas: 3
  maxReplicas: 20

env:
  ENVIRONMENT: production
  LOG_LEVEL:   WARNING

externalSecrets:
  secrets:
    - secretKey: DATABASE_URL
      remoteRef:
        key:      shopwave-prod-db-url
    - secretKey: SECRET_KEY
      remoteRef:
        key:      shopwave-prod-jwt-secret
    - secretKey: ALLOWED_ORIGINS
      remoteRef:
        key:      shopwave-prod-allowed-origins`}</CodeBlock>

<CodeBlock lang="yaml" filename="helm/shopwave/templates/deployment.yaml">{`apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "shopwave.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "shopwave.labels" . | nindent 4 }}
  annotations:
    deployment.kubernetes.io/revision: "{{ .Release.Revision }}"
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "shopwave.selectorLabels" . | nindent 6 }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge:       1
      maxUnavailable: 0        # Zero-downtime: never kill before new pod ready
  template:
    metadata:
      labels:
        {{- include "shopwave.selectorLabels" . | nindent 8 }}
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port:   "{{ .Values.service.port }}"
        prometheus.io/path:   "/metrics"
    spec:
      serviceAccountName: {{ include "shopwave.serviceAccountName" . }}
      securityContext:
        runAsNonRoot: true
        runAsUser:    1000
        fsGroup:      1000
      containers:
        - name: {{ .Chart.Name }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          env:
            {{- range $key, $val := .Values.env }}
            - name:  {{ $key }}
              value: {{ $val | quote }}
            {{- end }}
          envFrom:
            - secretRef:
                name: {{ include "shopwave.fullname" . }}-secrets
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          livenessProbe:
            {{- toYaml .Values.livenessProbe | nindent 12 }}
          readinessProbe:
            {{- toYaml .Values.readinessProbe | nindent 12 }}
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem:   true
            capabilities:
              drop: [ALL]`}</CodeBlock>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 7 â€” TERRAFORM INFRASTRUCTURE AS CODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="07" title="TERRAFORM â€” INFRASTRUCTURE AS CODE" sub="Every Azure resource declared, versioned, and applied through a pipeline." />

<p>All Azure infrastructure is managed by Terraform â€” no manual portal clicks, no ad-hoc CLI commands. The configuration is split into five focused modules, each owning a single concern. The root <code style={{color:T.accent3}}>main.tf</code> wires them together and additionally provisions GitHub Actions OIDC federation so the CD pipelines can authenticate to Azure without any stored credentials.</p>

<DiagramBox label="Terraform Module Dependency Graph">
  <svg viewBox="0 0 860 200" width="100%" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <marker id="tfa" markerWidth="7" markerHeight="7" refX="5" refY="3" orient="auto"><path d="M0,0 L0,6 L7,3 z" fill="#64748b"/></marker>
    </defs>
    {/* Root */}
    <rect x="340" y="10" width="170" height="50" rx="7" fill="#161a26" stroke="#3b82f6" strokeWidth="2"/>
    <rect x="340" y="10" width="170" height="20" rx="7" fill="#3b82f6" opacity="0.25"/>
    <text x="425" y="24" textAnchor="middle" fill="#93c5fd" fontSize="10" fontFamily="monospace" fontWeight="700">ROOT  main.tf</text>
    <text x="425" y="48" textAnchor="middle" fill="#64748b" fontSize="9" fontFamily="monospace">OIDC Â· namespaces Â· role assignments</text>

    {/* Networking */}
    <rect x="10"  y="110" width="140" height="70" rx="7" fill="#161a26" stroke="#a855f7" strokeWidth="1.5"/>
    <text x="80"  y="136" textAnchor="middle" fill="#d8b4fe" fontSize="10" fontFamily="monospace" fontWeight="700">networking</text>
    <text x="80"  y="153" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">VNet Â· subnets</text>
    <text x="80"  y="168" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">NSGs Â· DNS zone</text>

    {/* ACR */}
    <rect x="170" y="110" width="140" height="70" rx="7" fill="#161a26" stroke="#f97316" strokeWidth="1.5"/>
    <text x="240" y="136" textAnchor="middle" fill="#fdba74" fontSize="10" fontFamily="monospace" fontWeight="700">acr</text>
    <text x="240" y="153" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Container Registry</text>
    <text x="240" y="168" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">admin creds</text>

    {/* Key Vault */}
    <rect x="330" y="110" width="140" height="70" rx="7" fill="#161a26" stroke="#eab308" strokeWidth="1.5"/>
    <text x="400" y="136" textAnchor="middle" fill="#fde047" fontSize="10" fontFamily="monospace" fontWeight="700">keyvault</text>
    <text x="400" y="153" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">RBAC auth</text>
    <text x="400" y="168" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">seeds JWT secret</text>

    {/* AKS */}
    <rect x="490" y="110" width="140" height="70" rx="7" fill="#161a26" stroke="#3b82f6" strokeWidth="1.5"/>
    <text x="560" y="136" textAnchor="middle" fill="#93c5fd" fontSize="10" fontFamily="monospace" fontWeight="700">aks</text>
    <text x="560" y="153" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">cluster Â· node pools</text>
    <text x="560" y="168" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Log Analytics Â· Defender</text>

    {/* Postgres */}
    <rect x="650" y="110" width="140" height="70" rx="7" fill="#161a26" stroke="#22c55e" strokeWidth="1.5"/>
    <text x="720" y="136" textAnchor="middle" fill="#86efac" fontSize="10" fontFamily="monospace" fontWeight="700">postgres</text>
    <text x="720" y="153" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">Flexible Server</text>
    <text x="720" y="168" textAnchor="middle" fill="#64748b" fontSize="8" fontFamily="monospace">3 databases â†’ KV</text>

    {/* Arrows root â†’ modules */}
    <line x1="390" y1="62" x2="80"  y2="108" stroke="#64748b" strokeWidth="1" markerEnd="url(#tfa)"/>
    <line x1="405" y1="62" x2="240" y2="108" stroke="#64748b" strokeWidth="1" markerEnd="url(#tfa)"/>
    <line x1="425" y1="62" x2="400" y2="108" stroke="#64748b" strokeWidth="1" markerEnd="url(#tfa)"/>
    <line x1="445" y1="62" x2="560" y2="108" stroke="#64748b" strokeWidth="1" markerEnd="url(#tfa)"/>
    <line x1="460" y1="62" x2="720" y2="108" stroke="#64748b" strokeWidth="1" markerEnd="url(#tfa)"/>
  </svg>
</DiagramBox>

<h3 style={{fontFamily:"monospace",color:T.accent,margin:"32px 0 12px"}}>infrastructure/terraform/main.tf (root â€” key excerpts)</h3>

<p>The root module wires the five child modules together, passing outputs as inputs between them (e.g. the networking module's subnet IDs flow into both <code style={{color:T.accent3}}>aks</code> and <code style={{color:T.accent3}}>postgres</code>), and finishes by configuring GitHub Actions OIDC federation and creating the Kubernetes namespaces.</p>

<h3 style={{fontFamily:"monospace",color:T.accent,margin:"0 0 16px"}}>Step 0 â€” Bootstrap remote state (run once)</h3>

<p>Before running <code style={{color:T.accent3}}>terraform init</code> you need an Azure Storage account to hold the state file. A small helper script creates it and prints the values you need to paste into the <code style={{color:T.accent3}}>backend</code> block in <code style={{color:T.accent3}}>main.tf</code>.</p>

<CodeBlock lang="bash" filename="infrastructure/terraform/scripts/bootstrap-tfstate.sh">{`#!/usr/bin/env bash
# Run ONCE before terraform init.
# Creates the Azure Blob Storage backend for Terraform remote state.
set -euo pipefail

TFSTATE_RG="shopwave-tfstate-rg"
TFSTATE_SA="shopwavetfstate\${RANDOM}"   # globally unique suffix
LOCATION="\${1:-eastus}"

az group create --name "\$TFSTATE_RG" --location "\$LOCATION" --output none

az storage account create \\
  --name "\$TFSTATE_SA" --resource-group "\$TFSTATE_RG" \\
  --sku Standard_LRS --kind StorageV2 \\
  --min-tls-version TLS1_2 --allow-blob-public-access false --output none

# Enable versioning â€” protects state from accidental overwrites
az storage account blob-service-properties update \\
  --account-name "\$TFSTATE_SA" --resource-group "\$TFSTATE_RG" \\
  --enable-versioning true --output none

az storage container create \\
  --name tfstate --account-name "\$TFSTATE_SA" --auth-mode login --output none

echo "Update main.tf backend block with:"
echo "  storage_account_name = \\"\$TFSTATE_SA\\""
echo "  resource_group_name  = \\"\$TFSTATE_RG\\""
echo "Then: cp terraform.tfvars.example terraform.tfvars && terraform init"`}</CodeBlock>

<h3 style={{fontFamily:"monospace",color:T.accent,margin:"32px 0 16px"}}>infrastructure/terraform/main.tf â€” key excerpts</h3>

<p>The root module calls all five child modules in dependency order and then handles cross-cutting concerns: GitHub Actions OIDC federation, role assignments, and Kubernetes namespace creation via the <code style={{color:T.accent3}}>kubernetes</code> provider (which is configured using the AKS module's output).</p>

<CodeBlock lang="hcl" filename="infrastructure/terraform/main.tf">{`terraform {
  required_version = ">= 1.7.0"
  required_providers {
    azurerm = { source = "hashicorp/azurerm", version = "~> 3.110" }
    azuread = { source = "hashicorp/azuread", version = "~> 2.53"  }
    random  = { source = "hashicorp/random",  version = "~> 3.6"   }
    helm       = { source = "hashicorp/helm",       version = "~> 2.14" }
    kubernetes = { source = "hashicorp/kubernetes", version = "~> 2.31" }
  }
  backend "azurerm" {
    resource_group_name  = "shopwave-tfstate-rg"
    storage_account_name = "shopwavetfstate"    # from bootstrap-tfstate.sh
    container_name       = "tfstate"
    key                  = "shopwave.tfstate"
  }
}

module "networking" {
  source              = "./modules/networking"
  project             = var.project
  environment         = var.environment
  location            = var.location
  resource_group_name = azurerm_resource_group.main.name
  vnet_address_space  = var.vnet_address_space
  aks_subnet_cidr     = var.aks_subnet_cidr
  pg_subnet_cidr      = var.pg_subnet_cidr
  tags                = local.common_tags
}

module "keyvault" {
  source              = "./modules/keyvault"
  project             = var.project
  environment         = var.environment
  location            = var.location
  resource_group_name = azurerm_resource_group.main.name
  tenant_id           = data.azurerm_client_config.current.tenant_id
  admin_object_ids    = var.keyvault_admin_object_ids
  tags                = local.common_tags
}

module "acr" {
  source              = "./modules/acr"
  project             = var.project
  environment         = var.environment
  location            = var.location
  resource_group_name = azurerm_resource_group.main.name
  sku                 = var.acr_sku
  tags                = local.common_tags
}

module "aks" {
  source              = "./modules/aks"
  project             = var.project
  environment         = var.environment
  location            = var.location
  resource_group_name = azurerm_resource_group.main.name
  subnet_id           = module.networking.aks_subnet_id   # â† cross-module wiring
  acr_id              = module.acr.id
  keyvault_id         = module.keyvault.id
  node_count          = var.aks_node_count
  node_vm_size        = var.aks_node_vm_size
  kubernetes_version  = var.kubernetes_version
  min_node_count      = var.aks_min_node_count
  max_node_count      = var.aks_max_node_count
  tags                = local.common_tags
  depends_on          = [module.networking, module.acr, module.keyvault]
}

module "postgres" {
  source              = "./modules/postgres"
  project             = var.project
  environment         = var.environment
  location            = var.location
  resource_group_name = azurerm_resource_group.main.name
  subnet_id           = module.networking.pg_subnet_id          # â† private subnet
  private_dns_zone_id = module.networking.pg_private_dns_zone_id
  sku_name            = var.postgres_sku
  storage_mb          = var.postgres_storage_mb
  postgres_version    = var.postgres_version
  databases           = var.postgres_databases
  keyvault_id         = module.keyvault.id   # â† stores connection strings here
  tags                = local.common_tags
  depends_on          = [module.networking, module.keyvault]
}

# â”€â”€ GitHub Actions OIDC federation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
resource "azuread_application" "github_actions" {
  display_name = "\${var.project}-github-actions-\${var.environment}"
}
resource "azuread_service_principal" "github_actions" {
  client_id = azuread_application.github_actions.client_id
}
resource "azuread_application_federated_identity_credential" "staging" {
  application_id = azuread_application.github_actions.id
  display_name   = "\${var.project}-staging"
  audiences      = ["api://AzureADTokenExchange"]
  issuer         = "https://token.actions.githubusercontent.com"
  subject        = "repo:\${var.github_org}/\${var.github_repo}:environment:staging"
}
resource "azuread_application_federated_identity_credential" "production" {
  application_id = azuread_application.github_actions.id
  display_name   = "\${var.project}-production"
  audiences      = ["api://AzureADTokenExchange"]
  issuer         = "https://token.actions.githubusercontent.com"
  subject        = "repo:\${var.github_org}/\${var.github_repo}:environment:production"
}

# Role assignments â€” principle of least privilege
resource "azurerm_role_assignment" "gh_acr_push"  {
  scope = module.acr.id; role_definition_name = "AcrPush"
  principal_id = azuread_service_principal.github_actions.id
}
resource "azurerm_role_assignment" "gh_aks_user"  {
  scope = module.aks.id
  role_definition_name = "Azure Kubernetes Service Cluster User Role"
  principal_id = azuread_service_principal.github_actions.id
}
resource "azurerm_role_assignment" "gh_kv_secrets" {
  scope = module.keyvault.id; role_definition_name = "Key Vault Secrets User"
  principal_id = azuread_service_principal.github_actions.id
}

# Kubernetes namespaces â€” created via k8s provider post-AKS provisioning
resource "kubernetes_namespace" "staging"    {
  metadata { name = "shopwave-staging";    labels = { environment = "staging"    } }
  depends_on = [module.aks]
}
resource "kubernetes_namespace" "production" {
  metadata { name = "shopwave-production"; labels = { environment = "production" } }
  depends_on = [module.aks]
}`}</CodeBlock>

<h3 style={{fontFamily:"monospace",color:T.accent,margin:"32px 0 16px"}}>modules/aks/main.tf â€” production-hardened cluster</h3>

<p>The AKS module creates two node pools: a tainted <em>system</em> pool for Kubernetes internals and an <em>apps</em> pool for ShopWave workloads. Workload Identity, OIDC issuer, Container Insights, Microsoft Defender for Containers, and the Key Vault CSI driver are all enabled by default.</p>

<CodeBlock lang="hcl" filename="infrastructure/terraform/modules/aks/main.tf">{`resource "azurerm_kubernetes_cluster" "main" {
  name                = "\${var.project}-aks-\${var.environment}"
  location            = var.location
  resource_group_name = var.resource_group_name
  dns_prefix          = "\${var.project}-\${var.environment}"
  kubernetes_version  = var.kubernetes_version

  oidc_issuer_enabled       = true   # â† required for Workload Identity
  workload_identity_enabled = true

  default_node_pool {               # system pool â€” kube-system only
    name                         = "system"
    vm_size                      = var.node_vm_size
    vnet_subnet_id               = var.subnet_id
    enable_auto_scaling          = true
    min_count                    = var.min_node_count
    max_count                    = var.max_node_count
    only_critical_addons_enabled = true   # taint: NoSchedule for user workloads
    upgrade_settings { max_surge = "33%" }
  }

  identity { type = "SystemAssigned" }

  network_profile {
    network_plugin    = "azure"
    network_policy    = "azure"       # enforces NetworkPolicy objects
    load_balancer_sku = "standard"
    service_cidr      = "172.16.0.0/16"
    dns_service_ip    = "172.16.0.10"
  }

  oms_agent {                         # Container Insights
    log_analytics_workspace_id = azurerm_log_analytics_workspace.main.id
  }
  microsoft_defender {                # Defender for Containers
    log_analytics_workspace_id = azurerm_log_analytics_workspace.main.id
  }
  key_vault_secrets_provider {        # CSI driver for Key Vault secret injection
    secret_rotation_enabled  = true
    secret_rotation_interval = "2m"
  }

  automatic_channel_upgrade = "patch"
  tags = var.tags
}

# App node pool â€” user workloads land here (no taint)
resource "azurerm_kubernetes_cluster_node_pool" "apps" {
  name                  = "apps"
  kubernetes_cluster_id = azurerm_kubernetes_cluster.main.id
  vm_size               = var.node_vm_size
  vnet_subnet_id        = var.subnet_id
  enable_auto_scaling   = true
  min_count             = var.min_node_count
  max_count             = var.max_node_count
  mode                  = "User"
  tags                  = var.tags
}

# AKS pulls images from ACR without a stored password
resource "azurerm_role_assignment" "aks_acr_pull" {
  scope                = var.acr_id
  role_definition_name = "AcrPull"
  principal_id         = azurerm_kubernetes_cluster.main.kubelet_identity[0].object_id
}`}</CodeBlock>

<h3 style={{fontFamily:"monospace",color:T.accent,margin:"32px 0 16px"}}>modules/postgres/main.tf â€” secrets auto-stored in Key Vault</h3>

<p>The postgres module generates a random password, provisions the Flexible Server with per-service databases, and writes the full connection strings directly into Key Vault â€” so they're available to the External Secrets Operator without any manual copy-paste step.</p>

<CodeBlock lang="hcl" filename="infrastructure/terraform/modules/postgres/main.tf">{`resource "random_password" "postgres" {
  length  = 32; special = true
  override_special = "!#\$%&*()-_=+[]{}<>?"
}

resource "azurerm_postgresql_flexible_server" "main" {
  name                   = "\${var.project}-pg-\${var.environment}"
  resource_group_name    = var.resource_group_name
  location               = var.location
  version                = var.postgres_version
  delegated_subnet_id    = var.subnet_id           # private VNet access only
  private_dns_zone_id    = var.private_dns_zone_id
  administrator_login    = local.pg_admin
  administrator_password = random_password.postgres.result
  sku_name               = var.sku_name
  storage_mb             = var.storage_mb

  backup_retention_days        = var.environment == "production" ? 14 : 7
  geo_redundant_backup_enabled = var.environment == "production"

  high_availability {
    mode = var.environment == "production" ? "ZoneRedundant" : "Disabled"
  }
  tags = var.tags
  lifecycle { ignore_changes = [zone, high_availability[0].standby_availability_zone] }
}

# Create each per-service database
resource "azurerm_postgresql_flexible_server_database" "databases" {
  for_each  = toset(var.databases)
  name      = each.value
  server_id = azurerm_postgresql_flexible_server.main.id
  lifecycle { prevent_destroy = true }   # never drop a production database
}

# Write connection strings into Key Vault â€” one per database
resource "azurerm_key_vault_secret" "db_urls" {
  for_each     = local.db_urls
  name         = "\${var.project}-\${var.environment}-\${replace(each.key, "_", "-")}-url"
  value        = each.value       # postgresql+asyncpg://admin:pass@host/db?ssl=require
  key_vault_id = var.keyvault_id
}`}</CodeBlock>

<h3 style={{fontFamily:"monospace",color:T.accent,margin:"32px 0 16px"}}>infrastructure/terraform/variables.tf â€” fully validated</h3>

<CodeBlock lang="hcl" filename="infrastructure/terraform/variables.tf">{`variable "project" {
  type    = string; default = "shopwave"
  validation {
    condition     = can(regex("^[a-z][a-z0-9-]{2,20}\$", var.project))
    error_message = "Lowercase alphanumeric + hyphens, 3-20 chars."
  }
}
variable "environment" {
  type = string
  validation {
    condition     = contains(["staging", "production"], var.environment)
    error_message = "Must be 'staging' or 'production'."
  }
}
variable "location"           { type = string; default = "eastus" }
variable "subscription_id"    { type = string; sensitive = true }

# Networking
variable "vnet_address_space" { type = string; default = "10.0.0.0/16" }
variable "aks_subnet_cidr"    { type = string; default = "10.0.1.0/24" }
variable "pg_subnet_cidr"     { type = string; default = "10.0.2.0/24" }

# AKS
variable "kubernetes_version"  { type = string; default = "1.30" }
variable "aks_node_count"      { type = number; default = 3 }
variable "aks_node_vm_size"    { type = string; default = "Standard_D2s_v3" }
variable "aks_min_node_count"  { type = number; default = 2 }
variable "aks_max_node_count"  { type = number; default = 10 }

# PostgreSQL
variable "postgres_version"    { type = string; default = "16" }
variable "postgres_sku"        { type = string; default = "Standard_B2ms" }
variable "postgres_storage_mb" { type = number; default = 32768 }
variable "postgres_databases"  { type = list(string); default = ["auth_db","products_db","orders_db"] }

# Key Vault
variable "keyvault_admin_object_ids" { type = list(string); default = [] }

# GitHub OIDC
variable "github_org"  { type = string }
variable "github_repo" { type = string; default = "shopwave" }`}</CodeBlock>

<h3 style={{fontFamily:"monospace",color:T.accent,margin:"32px 0 16px"}}>infrastructure/terraform/outputs.tf â€” reads straight into GitHub Secrets</h3>

<CodeBlock lang="hcl" filename="infrastructure/terraform/outputs.tf">{`output "acr_login_server"          { value = module.acr.login_server }
output "aks_cluster_name"          { value = module.aks.cluster_name }
output "keyvault_name"             { value = module.keyvault.name }
output "postgres_fqdn"             { value = module.postgres.fqdn }
output "github_actions_client_id"  { value = azuread_application.github_actions.client_id }
output "tenant_id"                 { value = data.azurerm_client_config.current.tenant_id }

# acr_admin_username and acr_admin_password are marked sensitive=true
# retrieve them with: terraform output -raw acr_admin_username

output "github_secrets_summary" {
  sensitive = true
  value = <<-EOT
    AZURE_CLIENT_ID        = \${azuread_application.github_actions.client_id}
    AZURE_TENANT_ID        = \${data.azurerm_client_config.current.tenant_id}
    AZURE_SUBSCRIPTION_ID  = \${var.subscription_id}
    ACR_LOGIN_SERVER       = \${module.acr.login_server}
  EOT
}`}</CodeBlock>

<h3 style={{fontFamily:"monospace",color:T.accent,margin:"32px 0 16px"}}>Deploying infrastructure end-to-end</h3>

<CodeBlock lang="bash" filename="terminal">{`# 1 â€” Bootstrap remote state (once only)
cd infrastructure/terraform
chmod +x scripts/bootstrap-tfstate.sh
./scripts/bootstrap-tfstate.sh
# Update the backend block in main.tf with the printed storage account name

# 2 â€” Configure your environment
cp terraform.tfvars.example terraform.tfvars
# Edit: subscription_id, github_org, keyvault_admin_object_ids

# 3 â€” Initialise, plan, apply
terraform init
terraform plan \\
  -var-file="environments/production/production.tfvars" \\
  -var="subscription_id=\$(az account show --query id -o tsv)" \\
  -out=tfplan
terraform apply tfplan

# 4 â€” Copy output values to GitHub Secrets
terraform output github_secrets_summary
terraform output -raw acr_admin_username   # â†’ ACR_USERNAME
terraform output -raw acr_admin_password   # â†’ ACR_PASSWORD`}</CodeBlock>

<Callout type="info" title="Terraform environments">
  Two environment-specific <code>.tfvars</code> files live under <code>environments/</code>. Staging uses smaller VM sizes (<code>Standard_B2s</code>) and a single-node PostgreSQL SKU. Production uses <code>Standard_D2s_v3</code> nodes, zone-redundant PostgreSQL HA, 14-day backups, and a minimum of three AKS nodes. Both share the same Terraform code â€” only the variable values differ.
</Callout>

<h3 style={{fontFamily:"monospace",color:T.accent,margin:"32px 0 16px"}}>Secrets â†’ Key Vault â†’ pods: the full chain</h3>

<p>After Terraform runs, all connection strings and secrets live in Key Vault. The External Secrets Operator reads them and materialises them as Kubernetes Secrets, which Helm mounts into pods via <code style={{color:T.accent3}}>envFrom</code>. No secret is ever written to a pipeline log or a YAML file.</p>

<CodeBlock lang="yaml" filename="helm/shopwave/templates/externalsecret.yaml">{`{{- if .Values.externalSecrets.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "shopwave.fullname" . }}-secrets
  namespace: {{ .Release.Namespace }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreName }}
    kind: ClusterSecretStore
  target:
    name:           {{ include "shopwave.fullname" . }}-secrets
    creationPolicy: Owner
  data:
    {{- range .Values.externalSecrets.secrets }}
    - secretKey: {{ .secretKey }}
      remoteRef:
        key:     {{ .remoteRef.key }}
        version: {{ .remoteRef.version | default "latest" }}
    {{- end }}
{{- end }}`}</CodeBlock>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 8 â€” LOCAL DEVELOPMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="08" title="LOCAL DEVELOPMENT SETUP" sub="docker-compose for the full stack locally, pytest for fast iteration." />

<CodeBlock lang="yaml" filename="docker-compose.yml">{`version: "3.9"

services:

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER:     shopwave
      POSTGRES_PASSWORD: shopwave_local
      POSTGRES_MULTIPLE_DATABASES: auth_db,products_db,orders_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init.sh
    ports:
      - "5432:5432"
    healthcheck:
      test:     ["CMD-SHELL", "pg_isready -U shopwave"]
      interval: 10s
      timeout:  5s
      retries:  5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru

  api-gateway:
    build:
      context: services/api-gateway
      target:  production
    ports:
      - "8000:8000"
    env_file: .env.local
    environment:
      AUTH_SERVICE_URL:    http://auth-service:8001
      PRODUCT_SERVICE_URL: http://product-service:8002
      ORDER_SERVICE_URL:   http://order-service:8003
      REDIS_URL:           redis://redis:6379/0
    depends_on:
      - auth-service
      - product-service
      - order-service
    healthcheck:
      test:     ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout:  5s

  auth-service:
    build:
      context: services/auth-service
      target:  production
    ports:
      - "8001:8001"
    env_file: .env.local
    environment:
      DATABASE_URL: postgresql+asyncpg://shopwave:shopwave_local@postgres:5432/auth_db
      ENVIRONMENT:  local
    depends_on:
      postgres:
        condition: service_healthy

  product-service:
    build:
      context: services/product-service
      target:  production
    ports:
      - "8002:8002"
    env_file: .env.local
    environment:
      DATABASE_URL: postgresql+asyncpg://shopwave:shopwave_local@postgres:5432/products_db
      ENVIRONMENT:  local
    depends_on:
      postgres:
        condition: service_healthy

  order-service:
    build:
      context: services/order-service
      target:  production
    ports:
      - "8003:8003"
    env_file: .env.local
    environment:
      DATABASE_URL: postgresql+asyncpg://shopwave:shopwave_local@postgres:5432/orders_db
      ENVIRONMENT:  local
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres_data:`}</CodeBlock>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 9 â€” SECRETS REFERENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="09" title="GITHUB SECRETS REFERENCE" sub="Every secret the pipelines need â€” where it comes from, what it does." />

<DiagramBox label="Required GitHub Secrets">
  <table style={{ width: "100%", borderCollapse: "collapse", fontSize: "0.85rem", fontFamily: "monospace" }}>
    <thead>
      <tr>
        {["Secret Name", "Where to get it", "Used in", "Notes"].map(h => (
          <th key={h} style={{ borderBottom: `1px solid ${T.border}`, padding: "10px 14px", textAlign: "left", color: T.accent, fontSize: "10px", letterSpacing: "0.12em", textTransform: "uppercase" }}>{h}</th>
        ))}
      </tr>
    </thead>
    <tbody>
      {[
        ["AZURE_CLIENT_ID",       "terraform output github_actions_client_id",  "All pipelines",             "OIDC federated identity â€” no password"],
        ["AZURE_TENANT_ID",       "terraform output tenant_id",                 "All pipelines",             "Your Azure AD tenant"],
        ["AZURE_SUBSCRIPTION_ID", "terraform output subscription_id",           "All pipelines",             "Target subscription"],
        ["ACR_LOGIN_SERVER",      "terraform output acr_login_server",          "CI build + CD deploy",      "e.g. shopwaveacr.azurecr.io"],
        ["ACR_USERNAME",          "terraform output -raw acr_admin_username",   "CI build (docker login)",   "ACR admin username"],
        ["ACR_PASSWORD",          "terraform output -raw acr_admin_password",   "CI build (docker login)",   "Rotate regularly"],
        ["SLACK_WEBHOOK_URL",     "Slack app â†’ Incoming Webhooks",              "All pipelines (notify)",    "Incoming webhook URL"],
        ["CODECOV_TOKEN",         "codecov.io project settings",                "CI test job",               "Coverage upload token"],
      ].map(([name, source, used, note]) => (
        <tr key={name} style={{ borderBottom: `1px solid ${T.border}` }}>
          <td style={{ padding: "10px 14px", color: T.accent3 }}>{name}</td>
          <td style={{ padding: "10px 14px", color: T.muted, fontSize: "0.8rem" }}>{source}</td>
          <td style={{ padding: "10px 14px", color: T.muted, fontSize: "0.8rem" }}>{used}</td>
          <td style={{ padding: "10px 14px", color: T.muted, fontSize: "0.8rem" }}>{note}</td>
        </tr>
      ))}
    </tbody>
  </table>
</DiagramBox>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 10 â€” END-TO-END DEVELOPER WORKFLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="10" title="END-TO-END DEVELOPER WORKFLOW" sub="From git commit to live production â€” every step automated." />

<DiagramBox label="Complete Developer â†’ Production Journey">
  <svg viewBox="0 0 860 590" width="100%" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <marker id="wfa" markerWidth="7" markerHeight="7" refX="5" refY="3" orient="auto">
        <path d="M0,0 L0,6 L7,3 z" fill="#64748b"/>
      </marker>
      <marker id="wfg" markerWidth="7" markerHeight="7" refX="5" refY="3" orient="auto">
        <path d="M0,0 L0,6 L7,3 z" fill="#22c55e"/>
      </marker>
    </defs>

    {/* Timeline line */}
    <line x1="60" y1="30" x2="60" y2="560" stroke="#1e2840" strokeWidth="2"/>

    {[
      { y: 40,  icon: "1", color: "#a855f7", title: "Developer opens PR",              detail: "git checkout -b feat/add-wishlist â†’ git push â†’ PR opened",                          time: "T+0" },
      { y: 110, icon: "2", color: "#3b82f6", title: "CI triggers (path-filtered)",     detail: "Only product-service CI runs Â· lint â†’ test â†’ SAST Â· ~6 min",                      time: "T+6m" },
      { y: 180, icon: "3", color: "#22c55e", title: "Tests pass Â· PR reviewable",      detail: "GitHub status checks green Â· Coverage badge updates Â· Codecov report",             time: "T+7m" },
      { y: 250, icon: "4", color: "#eab308", title: "Code review + merge to main",     detail: "Reviewer approves Â· Squash merge Â· CI re-runs on main branch",                     time: "T+Xh" },
      { y: 320, icon: "5", color: "#f97316", title: "CI builds + pushes to ACR",       detail: "Multi-stage Docker build Â· Trivy scan (block on CRITICAL) Â· Push sha-XXXXXXXX",    time: "T+Xh+8m" },
      { y: 390, icon: "6", color: "#3b82f6", title: "CD staging auto-deploys",         detail: "Helm upgrade --atomic Â· Smoke tests Â· Slack alert Â· staging tag created",           time: "T+Xh+13m" },
      { y: 460, icon: "7", color: "#22c55e", title: "Manual gate â†’ production",        detail: "Engineer triggers cd-production.yml Â· Reviewer approves Â· Rolling deploy â†’ live",   time: "T+Xh+30m" },
      { y: 530, icon: "â˜…", color: "#ec4899", title: "Infra change? terraform.yml",     detail: "PR touches infrastructure/terraform/ â†’ plan comment on PR â†’ apply on dispatch",     time: "as needed" },
    ].map(({ y, icon, color, title, detail, time }) => (
      <g key={y}>
        <circle cx="60" cy={y+12} r="14" fill={`${color}22`} stroke={color} strokeWidth="1.5"/>
        <text x="60" y={y+17} textAnchor="middle" fill={color} fontSize="11" fontFamily="monospace" fontWeight="700">{icon}</text>
        <line x1="76" y1={y+12} x2="110" y2={y+12} stroke={T.border} strokeWidth="1"/>
        <rect x="112" y={y} width="710" height="50" rx="6" fill={T.surface2} stroke={`${color}33`} strokeWidth="1"/>
        <text x="126" y={y+18} fill="#fff" fontSize="11" fontFamily="monospace" fontWeight="700">{title}</text>
        <text x="126" y={y+36} fill={T.muted} fontSize="9" fontFamily="monospace">{detail}</text>
        <text x="806" y={y+18} textAnchor="end" fill={color} fontSize="9" fontFamily="monospace">{time}</text>
      </g>
    ))}
  </svg>
</DiagramBox>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 11 â€” NETWORK POLICIES & SECURITY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="11" title="NETWORK POLICIES & ZERO-TRUST KUBERNETES" sub="Services can only talk to who they need to." />

<CodeBlock lang="yaml" filename="k8s/network-policies.yaml">{`# Default deny-all in production namespace
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: shopwave-production
spec:
  podSelector: {}
  policyTypes: [Ingress, Egress]

# Allow ingress from nginx ingress controller â†’ api-gateway only
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-gateway
  namespace: shopwave-production
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: api-gateway
  policyTypes: [Ingress]
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx

# Allow api-gateway â†’ each backend service
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-gateway-to-services
  namespace: shopwave-production
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: backend-service
  policyTypes: [Ingress]
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: api-gateway
      ports:
        - protocol: TCP
          port:     8001
        - protocol: TCP
          port:     8002
        - protocol: TCP
          port:     8003

# Allow all services egress to Azure DB (private endpoint)
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-egress-to-postgres
  namespace: shopwave-production
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/component: backend-service
  policyTypes: [Egress]
  egress:
    - ports:
        - protocol: TCP
          port:     5432`}</CodeBlock>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    SECTION 12 â€” PIPELINE SECURITY SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="12" title="SECURITY POSTURE SUMMARY" sub="Every layer of the pipeline hardened against common attack vectors." />

<DiagramBox label="Security Controls â€” Layer by Layer">
  <svg viewBox="0 0 860 430" width="100%" xmlns="http://www.w3.org/2000/svg">
    {[
      { y: 20,  label: "CODE",        color: "#a855f7", items: ["Semgrep SAST (p/python, p/owasp-top-ten, p/jwt)", "Ruff + mypy static analysis on every PR", "Dependabot auto-PRs for vulnerable dependencies"] },
      { y: 110, label: "IMAGE",       color: "#3b82f6", items: ["Multi-stage build â€” distroless final image (~15MB)", "Trivy scans CRITICAL/HIGH CVEs â€” blocks pipeline", "Cosign image signing â€” ACR verifies before deploy"] },
      { y: 200, label: "INFRA",       color: "#ec4899", items: ["All Azure resources declared in Terraform â€” no manual changes", "terraform plan diff commented on every infra PR", "Remote state in Azure Blob with versioning enabled"] },
      { y: 290, label: "RUNTIME",     color: "#22c55e", items: ["runAsNonRoot: true Â· readOnlyRootFilesystem: true", "capabilities: drop [ALL] â€” zero Linux capabilities", "Azure Network Policy â€” default deny, explicit allow-list"] },
      { y: 380, label: "CREDENTIALS", color: "#eab308", items: ["OIDC Workload Identity â€” zero static credentials in pipelines", "Azure Key Vault â€” connection strings auto-seeded by Terraform", "Secret rotation via Key Vault versioning + ESO 1h refresh"] },
    ].map(({ y, label, color, items }) => (
      <g key={y}>
        <rect x="10" y={y} width="90" height="80" rx="6" fill={`${color}15`} stroke={color} strokeWidth="1.5"/>
        <text x="55" y={y+46} textAnchor="middle" fill={color} fontSize="11" fontFamily="monospace" fontWeight="700">{label}</text>
        <rect x="115" y={y+4} width="730" height="72" rx="6" fill="#161a26" stroke={`${color}33`} strokeWidth="1"/>
        {items.map((item, i) => (
          <text key={i} x="130" y={y + 22 + i * 20} fill="#94a3b8" fontSize="10" fontFamily="monospace">
            <tspan fill={color} fontSize="10">â–¸ </tspan>{item}
          </text>
        ))}
      </g>
    ))}
  </svg>
</DiagramBox>

{/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    CONCLUSION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
<SectionHeader num="13" title="WHAT YOU NOW HAVE" sub="A complete, production-deployable E-Commerce platform." />

<p>Every component in this walkthrough is a real, working piece of the ShopWave system. Here is the complete inventory of what was built:</p>

<div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(260px, 1fr))", gap: "14px", margin: "28px 0" }}>
  {[
    { icon: "ğŸ", title: "4 Python FastAPI Services",        desc: "auth, product, order, api-gateway â€” each with async SQLAlchemy, Alembic migrations, structured logging, Prometheus metrics" },
    { icon: "âš™ï¸",  title: "7 GitHub Actions Pipelines",      desc: "4 per-service CI pipelines + staging CD + production CD + terraform.yml â€” path-filtered, OIDC-authenticated, Slack-notified" },
    { icon: "ğŸ—ï¸", title: "Terraform Infrastructure as Code", desc: "5 modules â€” networking, aks, acr, postgres, keyvault â€” all resources versioned, plan-reviewed on PR, applied through a gated pipeline" },
    { icon: "ğŸ”’", title: "End-to-End Security",              desc: "Semgrep SAST Â· Trivy image scan Â· Cosign signing Â· OIDC no-credential auth Â· Key Vault secrets auto-seeded by Terraform Â· zero-trust network policies" },
    { icon: "â˜¸ï¸",  title: "Helm Chart + K8s Manifests",      desc: "Single parameterised chart Â· rolling update strategy Â· HPA Â· PDB Â· External Secrets Â· RBAC Â· Network Policies" },
    { icon: "ğŸš€", title: "Zero-Downtime Deployments",        desc: "maxUnavailable: 0 rolling updates Â· --atomic Helm with auto-rollback Â· smoke tests gate every staging deploy" },
    { icon: "â˜ï¸",  title: "Full Azure Stack",                desc: "AKS + ACR + PostgreSQL Flexible (zone-redundant in prod) + Key Vault + private VNet + Azure Monitor + Defender for Containers â€” all Terraform-managed" },
  ].map(({ icon, title, desc }) => (
    <div key={title} style={{ background: T.surface2, border: `1px solid ${T.border}`, borderRadius: "10px", padding: "18px" }}>
      <div style={{ fontSize: "24px", marginBottom: "8px" }}>{icon}</div>
      <div style={{ fontFamily: "monospace", fontWeight: 700, color: "#fff", fontSize: "0.9rem", marginBottom: "8px" }}>{title}</div>
      <div style={{ color: T.muted, fontSize: "0.82rem", lineHeight: 1.6 }}>{desc}</div>
    </div>
  ))}
</div>

<Callout type="success" title="Next steps">
  From here, natural extensions include: switching Terraform to use <strong>Terraform Cloud</strong> or <strong>Atlantis</strong> for plan/apply with PR-based GitOps workflows; adding <strong>Argo Rollouts</strong> for canary deployments with automated metric-based promotion; integrating <strong>Azure Application Insights</strong> for distributed tracing across all four services; adding a <strong>contract testing</strong> job to each CI pipeline using Pact; and wiring <strong>Azure Cost Management</strong> alerts into the pipeline notifications.
</Callout>

<div style={{ borderTop: `1px solid ${T.border}`, marginTop: "60px", paddingTop: "32px", textAlign: "center" }}>
  <p style={{ fontFamily: "monospace", fontSize: "12px", color: T.muted }}>ShopWave Â· Python FastAPI Â· Azure AKS Â· Terraform IaC Â· GitHub Actions Â· Production-Grade CI/CD Â· February 2026</p>
</div>

</div>
